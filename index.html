<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Ray Mess Co — Dashboard</title>
    <meta name="theme-color" content="#CF9524">
    <meta name="description" content="Sistema de gestión de servicios de mensajería">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ray Mess Co">
    
    <link rel="manifest" href="https://raymessco.github.io/app_raymessco/manifest.json">
    <link rel="icon" href="https://raymessco.github.io/app_raymessco/icon-192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://raymessco.github.io/app_raymessco/icon-192.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://raymessco.github.io/app_raymessco/tailwind.css">
    
    <style>
      :root {
        --gold: #CF9524;
        --gold-light: #E5B858;
        --gold-dark: #A67A1D;
        --bg-dark: #0A0A0A;
        --bg-darker: #050505;
        --text-light: #F5F5F5;
        --text-gray: #A3A3A3;
      }
      
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      
      body {
        background: var(--bg-darker);
        color: var(--text-light);
        font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        touch-action: manipulation;
        margin: 0;
        padding: 0;
      }
      
      .hidden {
        display: none !important;
      }
      
      /* Login Styles */
      .login-container {
        background: linear-gradient(to bottom, var(--bg-darker), var(--bg-dark));
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      
      .login-card {
        background: rgba(15, 15, 15, 0.95);
        border: 1px solid var(--gold);
        border-radius: 16px;
        padding: 30px;
        width: 100%;
        max-width: 420px;
        box-shadow: 0 10px 30px rgba(207, 149, 36, 0.15);
        backdrop-filter: blur(10px);
      }
      
      .logo-container {
        text-align: center;
        margin-bottom: 25px;
      }
      
      .logo {
        width: 80px;
        height: 80px;
        margin-bottom: 15px;
        border-radius: 16px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }
      
      .app-name {
        font-size: 28px;
        font-weight: 700;
        color: var(--gold);
        margin-bottom: 5px;
      }
      
      .app-tagline {
        color: var(--text-gray);
        font-size: 14px;
        margin-bottom: 25px;
      }
      
      .google-btn {
        background: var(--gold);
        color: #000;
        border: none;
        border-radius: 12px;
        padding: 16px;
        width: 100%;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }
      
      .google-btn:hover {
        background: var(--gold-light);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(207, 149, 36, 0.3);
      }
      
      .google-btn:active {
        transform: translateY(0);
      }
      
      .auth-status {
        margin-top: 15px;
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        font-size: 14px;
      }
      
      .auth-status.success {
        background: rgba(34, 197, 94, 0.2);
        color: #BBF7D0;
      }
      
      .auth-status.error {
        background: rgba(239, 68, 68, 0.2);
        color: #FECACA;
      }
      
      /* Main App Styles */
      .app-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        background: var(--bg-darker);
      }
      
      .app-header {
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--gold);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 50;
      }
      
      .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      
      .menu-btn {
        color: var(--gold);
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: background 0.2s;
      }
      
      .menu-btn:hover {
        background: rgba(207, 149, 36, 0.1);
      }
      
      .header-logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .header-logo img {
        width: 36px;
        height: 36px;
        border-radius: 10px;
      }
      
      .header-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--gold);
      }
      
      .role-badge {
        background: rgba(207, 149, 36, 0.15);
        color: var(--gold);
        border: 1px solid var(--gold);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }
      
      .header-right {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      
      .user-name {
        color: var(--text-gray);
        font-size: 14px;
        display: none;
      }
      
      .logout-btn {
        background: rgba(239, 68, 68, 0.2);
        color: #FECACA;
        border: 1px solid rgba(239, 68, 68, 0.5);
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .logout-btn:hover {
        background: rgba(239, 68, 68, 0.3);
      }
      
      /* Sidebar Styles */
      .sidebar-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 99;
        display: none;
      }
      
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: 280px;
        background: var(--bg-dark);
        border-right: 1px solid var(--gold);
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--gold);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .sidebar-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--gold);
      }
      
      .close-sidebar {
        color: var(--gold);
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        transition: background 0.2s;
      }
      
      .close-sidebar:hover {
        background: rgba(207, 149, 36, 0.1);
      }
      
      .sidebar-menu {
        padding: 20px;
        flex-grow: 1;
        overflow-y: auto;
      }
      
      .menu-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        color: var(--text-light);
        text-decoration: none;
        border-radius: 12px;
        margin-bottom: 10px;
        transition: all 0.2s;
        cursor: pointer;
      }
      
      .menu-item:hover {
        background: rgba(207, 149, 36, 0.1);
        color: var(--gold);
      }
      
      .menu-item i {
        width: 24px;
        text-align: center;
        font-size: 18px;
      }
      
      .menu-item-text {
        font-weight: 500;
      }
      
      /* Main Content Styles */
      .main-content {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
      }
      
      .section-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--gold);
        margin-bottom: 20px;
      }
      
      .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
      }
      
      .filter-btn {
        background: rgba(207, 149, 36, 0.1);
        color: var(--gold);
        border: 1px solid var(--gold);
        border-radius: 20px;
        padding: 8px 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .filter-btn:hover, .filter-btn.active {
        background: var(--gold);
        color: #000;
      }
      
      .services-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      @media (min-width: 768px) {
        .services-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        
        .user-name {
          display: block;
        }
      }
      
      @media (min-width: 1200px) {
        .services-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      
      .service-card {
        background: rgba(20, 20, 20, 0.8);
        border: 1px solid rgba(207, 149, 36, 0.3);
        border-radius: 16px;
        padding: 20px;
        transition: all 0.3s ease;
      }
      
      .service-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(207, 149, 36, 0.15);
        border-color: var(--gold);
      }
      
      .service-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }
      
      .service-client {
        font-weight: 700;
        font-size: 18px;
        color: var(--text-light);
      }
      
      .service-status {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }
      
      .status-pendiente {
        background: rgba(185, 28, 28, 0.2);
        color: #FECACA;
      }
      
      .status-en_ruta {
        background: rgba(161, 98, 7, 0.2);
        color: #FDE68A;
      }
      
      .status-entregado {
        background: rgba(21, 128, 61, 0.2);
        color: #BBF7D0;
      }
      
      .status-cancelado {
        background: rgba(107, 114, 128, 0.2);
        color: #D1D5DB;
      }
      
      .service-detail {
        margin-bottom: 10px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      
      .service-detail i {
        color: var(--gold);
        margin-top: 3px;
        min-width: 16px;
      }
      
      .service-detail-content {
        flex-grow: 1;
        font-size: 14px;
      }
      
      .service-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      
      .action-btn {
        flex: 1;
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }
      
      .btn-primary {
        background: var(--gold);
        color: #000;
      }
      
      .btn-primary:hover {
        background: var(--gold-light);
      }
      
      .btn-secondary {
        background: rgba(59, 130, 246, 0.2);
        color: #93C5FD;
        border: 1px solid rgba(59, 130, 246, 0.5);
      }
      
      .btn-secondary:hover {
        background: rgba(59, 130, 246, 0.3);
      }
      
      .btn-danger {
        background: rgba(239, 68, 68, 0.2);
        color: #FECACA;
        border: 1px solid rgba(239, 68, 68, 0.5);
      }
      
      .btn-danger:hover {
        background: rgba(239, 68, 68, 0.3);
      }
      
      /* Modal Styles */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      }
      
      .filter-btn.active {
        background-color: #fbbf24; /* amarillo dorado */
        color: #000;
        font-weight: bold;
        border: 1px solid #000;
      }
      
      .modal-content {
        background: var(--bg-dark);
        border: 1px solid var(--gold);
        border-radius: 16px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 25px;
        position: relative;
      }
      
      .modal-header {
        text-align: center;
        margin-bottom: 25px;
      }
      
      .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--gold);
        margin-bottom: 10px;
      }
      
      .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        color: var(--text-gray);
        font-size: 24px;
        cursor: pointer;
        transition: color 0.2s;
      }
      
      .modal-close:hover {
        color: var(--gold);
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-light);
        font-weight: 500;
      }
      
      .form-input {
        width: 100%;
        background: rgba(207, 149, 36, 0.1);
        border: 1px solid var(--gold);
        border-radius: 8px;
        padding: 12px 15px;
        color: var(--text-light);
        font-size: 16px;
      }
      
      .form-input::placeholder {
        color: rgba(207, 149, 36, 0.7);
      }
      
      .form-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(207, 149, 36, 0.3);
      }
      
      .form-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .form-checkbox input {
        width: 18px;
        height: 18px;
        accent-color: var(--gold);
      }
      
      .form-checkbox label {
        color: var(--text-light);
      }
      
      .form-actions {
        display: flex;
        gap: 15px;
        margin-top: 25px;
      }
      
      .btn-submit {
        background: var(--gold);
        color: #000;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-weight: 600;
        cursor: pointer;
        flex: 1;
        transition: background 0.2s;
      }
      
      .btn-submit:hover {
        background: var(--gold-light);
      }
      
      .btn-cancel {
        background: rgba(239, 68, 68, 0.2);
        color: #FECACA;
        border: 1px solid rgba(239, 68, 68, 0.5);
        border-radius: 8px;
        padding: 12px 20px;
        font-weight: 600;
        cursor: pointer;
        flex: 1;
        transition: all 0.2s;
      }
      
      .btn-cancel:hover {
        background: rgba(239, 68, 68, 0.3);
      }
      
      /* Role Selection Modal */
      .role-modal {
        text-align: center;
      }
      
      .role-options {
        display: flex;
        gap: 15px;
        margin-top: 25px;
      }
      
      .role-option {
        flex: 1;
        background: rgba(20, 20, 20, 0.8);
        border: 1px solid var(--gold);
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .role-option:hover {
        background: rgba(207, 149, 36, 0.1);
        transform: translateY(-3px);
      }
      
      .role-icon {
        font-size: 32px;
        color: var(--gold);
        margin-bottom: 15px;
      }
      
      .role-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--text-light);
      }
      
      .role-description {
        font-size: 14px;
        color: var(--text-gray);
      }
      
      /* Responsive adjustments */
      @media (max-width: 768px) {
        .role-options {
          flex-direction: column;
        }
        
        .modal-content {
          padding: 20px 15px;
        }
      }
      
      /* Utility classes */
      .text-gold {
        color: var(--gold);
      }
      
      .clickable {
        cursor: pointer;
        color: #3b82f6;
        text-decoration: underline;
      }
      
      .mt-4 {
        margin-top: 1rem;
      }
      
      .mb-4 {
        margin-bottom: 1rem;
      }
      
      .text-center {
        text-align: center;
      }
      
      /* PWA Install Button - Mejorado */
      .install-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--gold);
        color: #000;
        border: none;
        border-radius: 30px;
        padding: 12px 20px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
      }
      
      .install-btn:hover {
        background: var(--gold-light);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(207, 149, 36, 0.4);
      }
      
      /* Financial summary */
      .financial-card {
        background: rgba(20, 20, 20, 0.8);
        border: 1px solid var(--gold);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .financial-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(207, 149, 36, 0.3);
      }
      
      .financial-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      
      /* History section */
      .history-day {
        margin-bottom: 30px;
      }
      
      .history-date {
        font-size: 18px;
        font-weight: 600;
        color: var(--gold);
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 1px solid var(--gold);
      }
      
      /* Pending requests */
      .pending-card {
        background: rgba(20, 20, 20, 0.8);
        border: 1px solid var(--gold);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .pending-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      
      /* Service date info */
      .service-date {
        font-size: 12px;
        color: var(--text-gray);
        margin-top: 10px;
      }

      .service-detail-content i {
        font-size: 22px !important; /* Tamaño más grande solo para los íconos */
        margin-left: 6px; /* Espaciado adicional entre texto e ícono */
      }

      /* SOLO el botón de Google Maps */
      .btn-maps {
        background: transparent;
        border: none;
        padding: 0;
      }

      .btn-maps i {
        background: transparent !important;
        border: none !important;
        color: #cfa924; /* DORADO */
        font-size: 20px;
      }

      /* Mejorar visualización de tablas en móvil */
      table {
        min-width: 600px;
      }

      th, td {
        text-align: left;
        font-size: 14px;
      }

      @media (max-width: 640px) {
        th, td {
          font-size: 12px;
          padding: 6px;
        }
      }
      
      /* Nuevos estilos para mejorar la experiencia de carga */
      .skeleton-loader {
        background: linear-gradient(90deg, #151515 0%, #1e1e1e 50%, #151515 100%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 8px;
      }
      
      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      
      .services-loading {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      @media (min-width: 768px) {
        .services-loading {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      @media (min-width: 1200px) {
        .services-loading {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      
      .service-card-skeleton {
        background: rgba(20, 20, 20, 0.8);
        border: 1px solid rgba(207, 149, 36, 0.3);
        border-radius: 16px;
        padding: 20px;
        height: 250px;
      }
      
      /* Mejoras para la visualización inicial */
      .app-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 60vh;
        flex-direction: column;
        gap: 20px;
      }
      
      .app-loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(207, 149, 36, 0.3);
        border-radius: 50%;
        border-top-color: var(--gold);
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .app-loading-text {
        color: var(--gold);
        font-size: 18px;
        text-align: center;
      }
    </style>
</head>
<body>
    <!-- Login View -->
    <div id="login-view" class="login-container">
      <div class="login-card">
        <div class="logo-container">
          <img src="https://raymessco.github.io/app_raymessco/icon-192.png" class="logo" alt="Ray Mess Co Logo">
          <h1 class="app-name">Ray Mess Co</h1>
          <p class="app-tagline">Sistema de gestión de servicios de mensajería</p>
        </div>
        
        <div id="auth-status" class="auth-status hidden"></div>
        
        <button id="btn-google" class="google-btn">
          <i class="fab fa-google"></i>
          <span id="btn-text">Continuar con Google</span>
          <div id="btn-loader" class="hidden">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
        </button>
        
        <p class="text-center mt-4 text-gold" style="font-size: 12px;">
          <i class="fas fa-info-circle"></i> Selecciona tu cuenta de Google para continuar
        </p>
      </div>
    </div>

    <!-- App View -->
    <div id="app" class="app-container hidden">
      <div class="app-header">
        <div class="header-left">
          <button id="sidebar-toggle" class="menu-btn">
            <i class="fas fa-bars"></i>
          </button>
          <div class="header-logo">
            <img src="https://raymessco.github.io/app_raymessco/icon-192.png" alt="Logo">
            <span class="header-title">Ray Mess Co</span>
          </div>
          <span id="role-badge" class="role-badge">CLIENTE</span>
        </div>
        
        <div class="header-right">
          <span id="user-name" class="user-name"></span>
          <button id="btn-logout" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Salir
          </button>
        </div>
      </div>

      <div id="sidebar-backdrop" class="sidebar-backdrop"></div>

      <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
          <h2 class="sidebar-title">Menú</h2>
          <button class="close-sidebar">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="sidebar-menu">
          <!-- Servicios -->
          <div class="menu-item" onclick="showSection('services')">
            <i class="fas fa-clipboard-list"></i>
            <span class="menu-item-text">Servicios</span>
          </div>

          <!-- Costos -->
          <div id="menu-costos" class="menu-item hidden" onclick="showSection('costos')">
            <i class="fas fa-dollar-sign"></i>
            <span class="menu-item-text">Costos por empresa</span>
          </div>

          <!-- Cobros -->
          <div id="menu-cobros" class="menu-item hidden" onclick="showSection('cobros')">
            <i class="fas fa-cash-register"></i>
            <span class="menu-item-text">Cobros contra entrega</span>
          </div>

          <!-- Solicitudes de mensajero -->
          <div id="menu-pendientes" class="menu-item hidden" onclick="showSection('pending-mensajeros')">
            <i class="fas fa-user-clock"></i>
            <span class="menu-item-text">Solicitudes mensajero</span>
          </div>

          <!-- Finanzas mensajero -->
          <div id="menu-finanzas-mensajero" class="menu-item hidden" onclick="showSection('financial')">
            <i class="fas fa-chart-line"></i>
            <span class="menu-item-text">Mis Finanzas</span>
          </div>
          
          <div class="menu-item" onclick="openEditProfile()">
            <i class="fas fa-user-edit"></i>
            <span class="menu-item-text">Editar perfil</span>
          </div>
        </div>
      </div>

      <div class="main-content">
        <div id="pending-banner" class="hidden" style="background: rgba(161, 98, 7, 0.2); color: #FDE68A; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
          <i class="fas fa-clock"></i> Tu cuenta está en revisión para ser mensajero. Podrás usar funciones de mensajería una vez el administrador apruebe tu solicitud.
        </div>

        <!-- Loading State -->
        <div id="app-loading" class="app-loading">
          <div class="app-loading-spinner"></div>
          <div class="app-loading-text">Cargando servicios...</div>
        </div>

        <!-- Filters -->
        <div id="filters" class="filters-container">
          <button onclick="setFilter('all', this)" class="filter-btn active">Todos</button>
          <button onclick="setFilter('pendiente', this)" class="filter-btn">Pendientes</button>
          <button onclick="setFilter('en_ruta', this)" class="filter-btn">En ruta</button>
          <button onclick="setFilter('entregado', this)" class="filter-btn">Entregados</button>
          <button onclick="setFilter('cancelado', this)" class="filter-btn">Cancelados</button>
        </div>

        <!-- Sección de servicios -->
        <div id="services-section" class="services-grid"></div>

        <!-- Sección financiera -->
        <div id="financial-section" class="hidden">
          <h2 class="section-title">Resumen financiero</h2>
          <div class="financial-card">
            <div class="financial-item">
              <span>Total ganado:</span>
              <span id="total-earned" class="text-gold">$0</span>
            </div>
            <div class="financial-item">
              <span>Total pendiente de pago:</span>
              <span id="total-pending" class="text-gold">$0</span>
            </div>
            <div class="financial-item">
              <span>Total pagado:</span>
              <span id="total-paid" class="text-gold">$0</span>
            </div>
          </div>
          <h3 class="section-title">Detalle de servicios por día</h3>
          <div id="financial-list"></div>
        </div>

        <!-- Solicitudes de mensajeros -->
        <div id="pending-mensajeros-section" class="hidden">
          <h2 class="section-title">Solicitudes de Mensajeros</h2>
          <div id="pending-mensajeros-list"></div>
        </div>

        <!-- Costos por empresa -->
        <div id="costos-section" class="hidden">
          <h2 class="section-title">Costos por empresa</h2>
          <div id="costos-empresas"></div>
        </div>

        <!-- Cobros contra entrega -->
        <div id="cobros-section" class="hidden">
          <h2 class="section-title">Cobros contra entrega</h2>
          <div id="cobros-body"></div>
        </div>
      </div>
    </div>

    <!-- Modals (mantener el código existente de modales) -->
    <!-- ... -->

    <button id="install-button" class="install-btn hidden">
      <i class="fas fa-download"></i> Instalar
    </button>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <script>
      // Configuración de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCkjLdn1NYI5eApE4N5ylkGJnlYsmO5hq4",
        authDomain: "raymessco-ce1c0.firebaseapp.com",
        projectId: "raymessco-ce1c0",
        storageBucket: "raymessco-ce1c0.appspot.com",
        messagingSenderId: "829091900185",
        appId: "1:829091900185:web:1c61887780ff2639a5f388",
        measurementId: "G-38Q9K6CV7D"
      };

      // Inicializar Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      console.log("Firebase v8 inicializado correctamente");

      // Estado global
      let currentUser = null;
      let currentRole = null;
      let services = [];
      let currentFilter = 'all';
      let _userProfileUnsub = null;
      let currentServiceIdForEvidence = null;
      let selectedPaymentMethod = null;
      let mensajerosList = [];
      let deferredPrompt = null;
      let _servicesUnsubscribe = null;
      let servicesLoaded = false;

      // Referencias a elementos UI
      const loginView = document.getElementById('login-view');
      const appView = document.getElementById('app');
      const appLoading = document.getElementById('app-loading');
      const roleBadge = document.getElementById('role-badge');
      const userNameEl = document.getElementById('user-name');
      const menuCostos = document.getElementById('menu-costos');
      const menuCobros = document.getElementById('menu-cobros');
      const menuPendientes = document.getElementById('menu-pendientes');
      const menuFinanzasMensajero = document.getElementById('menu-finanzas-mensajero');
      const roleChoiceModal = document.getElementById('roleChoiceModal');
      const sidebarBackdrop = document.getElementById('sidebar-backdrop');
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const closeSidebarBtn = document.querySelector('.close-sidebar');
      const fieldCostoClienteContainer = document.getElementById('field-costo-cliente-container');
      const adminFields = document.getElementById('admin-fields');
      const cobrarFieldContainer = document.getElementById('cobrar-field-container');
      const installButton = document.getElementById('install-button');
      const mensajeroSelect = document.getElementById('field-mensajero');

      // Inicializar la aplicación
      function initApp() {
        // Manejar el resultado de la autenticación después de la redirección
        auth.getRedirectResult()
          .then((result) => {
            if (result.user) {
              console.log("Autenticación exitosa tras redirección:", result.user.email);
              showAuthStatus("¡Autenticación exitosa!", false);
            }
          }).catch((error) => {
            console.error("Error en getRedirectResult:", error);
            let errorMessage = "Error de autenticación";
            if (error.code) {
              errorMessage = `Error: ${error.message}`;
            }
            showAuthStatus(errorMessage, true);
          });

        // Event listeners para la interfaz
        sidebarToggle.addEventListener('click', toggleSidebar);
        closeSidebarBtn.addEventListener('click', toggleSidebar);
        sidebarBackdrop.addEventListener('click', toggleSidebar);
        
        document.getElementById('cobrar-check').addEventListener('change', (e) => {
          cobrarFieldContainer.classList.toggle('hidden', !e.target.checked);
        });
        
        document.getElementById('service-form').addEventListener('submit', handleServiceSubmit);
        document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
        document.getElementById('btn-logout').addEventListener('click', () => auth.signOut());
        document.getElementById('btn-google').addEventListener('click', signInWithGoogle);
        
        // Lógica para instalación PWA
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          installButton.classList.remove('hidden');
        });
        
        installButton.addEventListener('click', async () => {
          if (!deferredPrompt) return;
          
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          
          if (outcome === 'accepted') {
            installButton.classList.add('hidden');
          }
          deferredPrompt = null;
        });
        
        // Observador de autenticación (central)
        auth.onAuthStateChanged(handleAuthStateChange);

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
              .then(registration => console.log('Service Worker registrado:', registration))
              .catch(err => console.error('Error al registrar Service Worker:', err));
          });
        }
      }

      // Función para iniciar sesión con Google
      async function signInWithGoogle() {
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');

        btnText.textContent = 'Conectando...';
        btnLoader.classList.remove('hidden');
        showAuthStatus("Conectando con Google...", false);

        const provider = new firebase.auth.GoogleAuthProvider();

        try {
          // Primero intenta con popup (más fluido en la mayoría de navegadores)
          await auth.signInWithPopup(provider);
          console.log("Login exitoso con popup");
        } catch (error) {
          console.warn("Popup falló, usando redirect:", error);
          auth.signInWithRedirect(provider);
        }
      }

      // Manejar cambios en el estado de autenticación
      async function handleAuthStateChange(user) {
        if (!user) {
          // Usuario no autenticado
          currentUser = null;
          currentRole = null;
          services = [];
          servicesLoaded = false;
          appView.classList.add('hidden');
          loginView.classList.remove('hidden');
          
          cleanupListeners();
          
          // Ocultar loader del botón por si quedó visible
          document.getElementById('btn-text').textContent = 'Continuar con Google';
          document.getElementById('btn-loader').classList.add('hidden');

          return;
        }
        
        // Usuario autenticado
        loginView.classList.add('hidden');
        appView.classList.remove('hidden');
        currentUser = user;
        
        // Mostrar estado de carga
        appLoading.classList.remove('hidden');
        document.getElementById('services-section').innerHTML = '';
        
        // Obtener información del perfil
        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            userNameEl.textContent = userData.displayName || user.displayName || user.email || '';
            currentRole = userData.role || 'cliente';
          } else {
            // Usuario nuevo, mostrar selector de rol
            userNameEl.textContent = user.displayName || user.email || '';
            showRoleSelection();
            return;
          }
        } catch (error) {
          console.error("Error obteniendo datos de usuario:", error);
          userNameEl.textContent = user.displayName || user.email || '';
          currentRole = 'cliente';
        }
        
        updateUIByRole();
        subscribeToUserProfile(user.uid);
        subscribeServicesByRole();
        
        if (currentRole === 'admin') {
          loadMensajerosList();
        }
        
        showSection('services');
        setFilter('all', document.querySelector('#filters .filter-btn'));
      }

      // Función para mostrar el esqueleto de carga
      function showServicesSkeleton() {
        const servicesEl = document.getElementById('services-section');
        if (!servicesEl) return;
        
        let skeletonHTML = '<div class="services-loading">';
        for (let i = 0; i < 6; i++) {
          skeletonHTML += `
            <div class="service-card-skeleton">
              <div class="skeleton-loader" style="height: 20px; width: 60%; margin-bottom: 15px;"></div>
              <div class="skeleton-loader" style="height: 16px; width: 80%; margin-bottom: 10px;"></div>
              <div class="skeleton-loader" style="height: 16px; width: 90%; margin-bottom: 10px;"></div>
              <div class="skeleton-loader" style="height: 16px; width: 70%; margin-bottom: 15px;"></div>
              <div class="skeleton-loader" style="height: 40px; width: 100%; border-radius: 8px;"></div>
            </div>
          `;
        }
        skeletonHTML += '</div>';
        
        servicesEl.innerHTML = skeletonHTML;
      }

      // Suscribirse a servicios según el rol
      function subscribeServicesByRole() {
        const servicesEl = document.getElementById('services-section');
        
        // Mostrar esqueleto de carga inmediatamente
        showServicesSkeleton();
        
        // Cancelar cualquier suscripción anterior
        if (_servicesUnsubscribe) {
          try { _servicesUnsubscribe(); } catch (e) { console.warn("Error al cancelar suscripción anterior:", e); }
          _servicesUnsubscribe = null;
        }

        if (!currentUser || !currentRole) {
          servicesEl.innerHTML = '<div class="text-center text-gold">Esperando datos de usuario...</div>';
          return;
        }

        // ===== ADMIN =====
        if (currentRole === 'admin') {
          const query = db.collection('services').orderBy('fechaCreacion', 'desc');

          _servicesUnsubscribe = query.onSnapshot(snapshot => {
            const allServices = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            console.log("Servicios obtenidos (admin):", allServices);
            servicesLoaded = true;
            appLoading.classList.add('hidden');
            renderServices(allServices);
          }, err => {
            console.error("Error snapshot admin:", err);
            servicesEl.innerHTML = '<div class="text-center text-gold">Error cargando servicios.</div>';
            appLoading.classList.add('hidden');
          });

          return;
        }

        // ===== CLIENTE =====
        if (currentRole === 'cliente') {
          console.log("UID actual del cliente:", currentUser.uid);

          const query = db.collection('services')
                          .where('uidCliente', '==', currentUser.uid)
                          .orderBy('fechaCreacion', 'desc');

          _servicesUnsubscribe = query.onSnapshot(snapshot => {
            const allServices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            console.log("Servicios obtenidos (cliente):", allServices);
            servicesLoaded = true;
            appLoading.classList.add('hidden');
            renderServices(allServices);
          }, err => {
            console.error("Error snapshot cliente:", err);
            servicesEl.innerHTML = '<div class="text-center text-gold">Error cargando tus pedidos.</div>';
            appLoading.classList.add('hidden');
          });
          return;
        }

        // ===== MENSAJERO =====
        if (currentRole === 'mensajero') {
          const pendientesQuery = db.collection('services').where('estado', '==', 'pendiente');
          const propiosQuery = db.collection('services').where('uidMensajero', '==', currentUser.uid);

          let pendientesCache = [];
          let propiosCache = [];

          function combineAndRender() {
            const combined = [
              ...pendientesCache,
              ...propiosCache.filter(p => !pendientesCache.find(pd => pd.id === p.id))
            ];

            combined.sort((a, b) => {
              const at = a.fechaCreacion?.seconds || 0;
              const bt = b.fechaCreacion?.seconds || 0;
              return bt - at;
            });

            console.log("Servicios combinados para mensajero:", combined);
            servicesLoaded = true;
            appLoading.classList.add('hidden');
            renderServices(combined);
          }

          const unsubPendientes = pendientesQuery.onSnapshot(snapshot => {
            pendientesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            combineAndRender();
          }, err => {
            console.error("Error snapshot pendientes:", err);
            appLoading.classList.add('hidden');
          });

          const unsubPropios = propiosQuery.onSnapshot(snapshot => {
            propiosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            combineAndRender();
          }, err => {
            console.error("Error snapshot propios:", err);
            appLoading.classList.add('hidden');
          });

          // Guardar función que cancela ambos listeners
          _servicesUnsubscribe = () => {
            try { unsubPendientes(); } catch (e) {}
            try { unsubPropios(); } catch (e) {}
          };

          return;
        }

        // ===== MENSAJERO EN REVISIÓN =====
        if (currentRole === 'pending_mensajero') {
          servicesEl.innerHTML = '<div class="text-center text-gold">Tu cuenta está en revisión. No puedes ver servicios aún.</div>';
          appLoading.classList.add('hidden');
          return;
        }

        // ===== ROL DESCONOCIDO =====
        servicesEl.innerHTML = '<div class="text-center text-gold">Rol no reconocido</div>';
        appLoading.classList.add('hidden');
      }

      // Función para renderizar servicios
      function renderServices(data) {
        // ... (mantener la función renderServices existente, pero asegurarse de que oculte el loader)
        const servicesEl = document.getElementById('services-section');
        
        // Ocultar loader si está visible
        appLoading.classList.add('hidden');
        
        // Resto del código de renderServices...
        // ... (código existente de renderServices)
      }

      // El resto de las funciones se mantienen igual que en el código original
      // ... (cleanupListeners, showRoleSelection, selectRole, subscribeToUserProfile, updateUIByRole, etc.)

      // Inicializar la aplicación cuando el DOM esté listo
      document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
