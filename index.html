<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Ray Mess Co — Dashboard</title>
    <meta name="theme-color" content="#CF9524">
    <meta name="description" content="Sistema de gestión de servicios de mensajería">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ray Mess Co">
    
    <link rel="manifest" href="https://raymessco.github.io/app_raymessco/manifest.json">
    <link rel="icon" href="https://raymessco.github.io/app_raymessco/icon-192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://raymessco.github.io/app_raymessco/icon-192.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://raymessco.github.io/app_raymessco/tailwind.css">
    
    <style>
        :root {
            --gold: #CF9524;
            --gold-light: #E5B858;
            --gold-dark: #A67A1D;
            --bg-dark: #0A0A0A;
            --bg-darker: #050505;
            --text-light: #F5F5F5;
            --text-gray: #A3A3A3;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: var(--bg-darker);
            color: var(--text-light);
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            touch-action: manipulation;
            margin: 0;
            padding: 0;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Login Styles */
        .login-container {
            background: linear-gradient(to bottom, var(--bg-darker), var(--bg-dark));
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(15, 15, 15, 0.95);
            border: 1px solid var(--gold);
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 10px 30px rgba(207, 149, 36, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .app-name {
            font-size: 28px;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 5px;
        }
        
        .app-tagline {
            color: var(--text-gray);
            font-size: 14px;
            margin-bottom: 25px;
        }
        
        .google-btn {
            background: var(--gold);
            color: #000;
            border: none;
            border-radius: 12px;
            padding: 16px;
            width: 100%;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .google-btn:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(207, 149, 36, 0.3);
        }
        
        .google-btn:active {
            transform: translateY(0);
        }
        
        .auth-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
        }
        
        .auth-status.success {
            background: rgba(34, 197, 94, 0.2);
            color: #BBF7D0;
        }
        
        .auth-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #FECACA;
        }
        
        /* Main App Styles */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: var(--bg-darker);
        }
        
        .app-header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--gold);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .menu-btn {
            color: var(--gold);
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .menu-btn:hover {
            background: rgba(207, 149, 36, 0.1);
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-logo img {
            width: 36px;
            height: 36px;
            border-radius: 10px;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
        }
        
        .role-badge {
            background: rgba(207, 149, 36, 0.15);
            color: var(--gold);
            border: 1px solid var(--gold);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-name {
            color: var(--text-gray);
            font-size: 14px;
            display: none;
        }
        
        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #FECACA;
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        /* Sidebar Styles */
        .sidebar-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99;
            display: none;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 280px;
            background: var(--bg-dark);
            border-right: 1px solid var(--gold);
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sidebar-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
        }
        
        .close-sidebar {
            color: var(--gold);
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .close-sidebar:hover {
            background: rgba(207, 149, 36, 0.1);
        }
        
        .sidebar-menu {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .menu-item:hover {
            background: rgba(207, 149, 36, 0.1);
            color: var(--gold);
        }
        
        .menu-item i {
            width: 24px;
            text-align: center;
            font-size: 18px;
        }
        
        .menu-item-text {
            font-weight: 500;
        }
        
        /* Main Content Styles */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 20px;
        }
        
        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-btn {
            background: rgba(207, 149, 36, 0.1);
            color: var(--gold);
            border: 1px solid var(--gold);
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: var(--gold);
            color: #000;
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .services-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .user-name {
                display: block;
            }
        }
        
        @media (min-width: 1200px) {
            .services-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .service-card {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(207, 149, 36, 0.3);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(207, 149, 36, 0.15);
            border-color: var(--gold);
        }
        
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .service-client {
            font-weight: 700;
            font-size: 18px;
            color: var(--text-light);
        }
        
        .service-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pendiente {
            background: rgba(185, 28, 28, 0.2);
            color: #FECACA;
        }
        
        .status-en_ruta {
            background: rgba(161, 98, 7, 0.2);
            color: #FDE68A;
        }
        
        .status-entregado {
            background: rgba(21, 128, 61, 0.2);
            color: #BBF7D0;
        }
        
        .status-cancelado {
            background: rgba(107, 114, 128, 0.2);
            color: #D1D5DB;
        }
        
        .service-detail {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .service-detail i {
            color: var(--gold);
            margin-top: 3px;
            min-width: 16px;
        }
        
        .service-detail-content {
            flex-grow: 1;
            font-size: 14px;
        }
        
        .service-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .btn-primary {
            background: var(--gold);
            color: #000;
        }
        
        .btn-primary:hover {
            background: var(--gold-light);
        }
        
        .btn-secondary {
            background: rgba(59, 130, 246, 0.2);
            color: #93C5FD;
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        
        .btn-secondary:hover {
            background: rgba(59, 130, 246, 0.3);
        }
        
        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #FECACA;
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .filter-btn.active {
            background-color: #fbbf24;
            color: #000;
            font-weight: bold;
            border: 1px solid #000;
        }
        
        .modal-content {
            background: var(--bg-dark);
            border: 1px solid var(--gold);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 10px;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: var(--gold);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            background: rgba(207, 149, 36, 0.1);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 12px 15px;
            color: var(--text-light);
            font-size: 16px;
        }
        
        .form-input::placeholder {
            color: rgba(207, 149, 36, 0.7);
        }
        
        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(207, 149, 36, 0.3);
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--gold);
        }
        
        .form-checkbox label {
            color: var(--text-light);
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn-submit {
            background: var(--gold);
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            transition: background 0.2s;
        }
        
        .btn-submit:hover {
            background: var(--gold-light);
        }
        
        .btn-cancel {
            background: rgba(239, 68, 68, 0.2);
            color: #FECACA;
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 8px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s;
        }
        
        .btn-cancel:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        /* Role Selection Modal */
        .role-modal {
            text-align: center;
        }
        
        .role-options {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .role-option {
            flex: 1;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid var(--gold);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .role-option:hover {
            background: rgba(207, 149, 36, 0.1);
            transform: translateY(-3px);
        }
        
        .role-icon {
            font-size: 32px;
            color: var(--gold);
            margin-bottom: 15px;
        }
        
        .role-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-light);
        }
        
        .role-description {
            font-size: 14px;
            color: var(--text-gray);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .role-options {
                flex-direction: column;
            }
            
            .modal-content {
                padding: 20px 15px;
            }
        }
        
        /* Utility classes */
        .text-gold {
            color: var(--gold);
        }
        
        .clickable {
            cursor: pointer;
            color: #3b82f6;
            text-decoration: underline;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* PWA Install Button - Mejorado */
        .install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--gold);
            color: #000;
            border: none;
            border-radius: 30px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .install-btn:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(207, 149, 36, 0.4);
        }
        
        /* Financial summary */
        .financial-card {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid var(--gold);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .financial-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(207, 149, 36, 0.3);
        }
        
        .financial-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        /* History section */
        .history-day {
            margin-bottom: 30px;
        }
        
        .history-date {
            font-size: 18px;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--gold);
        }
        
        /* Pending requests */
        .pending-card {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid var(--gold);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .pending-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Service date info */
        .service-date {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 10px;
        }

        .service-detail-content i {
            font-size: 22px !important;
            margin-left: 6px;
        }

        /* SOLO el botón de Google Maps */
        .btn-maps {
            background: transparent;
            border: none;
            padding: 0;
        }

        .btn-maps i {
            background: transparent !important;
            border: none !important;
            color: #cfa924;
            font-size: 20px;
        }

        /* Mejorar visualización de tablas en móvil */
        table {
            min-width: 600px;
        }

        th, td {
            text-align: left;
            font-size: 14px;
        }

        @media (max-width: 640px) {
            th, td {
                font-size: 12px;
                padding: 6px;
            }
        }

        /* Ajuste para asegurar visibilidad */
        #services-section {
            position: relative;
            z-index: 50;
            padding: 1rem;
            background: var(--bg-darker);
            color: var(--text-light);
            display: block;
            overflow-y: auto;
        }

        /* Evita que otros elementos lo tapen */
        .app-container > *:first-child {
            margin-top: 0;
        }

/* ESTILO MUY ESPECÍFICO Y AGRESIVO */
#uidMensajero {
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    width: 100% !important;
    background: rgba(207, 149, 36, 0.1) !important;
    border: 1px solid #CF9524 !important;
    border-radius: 8px !important;
    padding: 12px 15px !important;
    color: #F5F5F5 !important;
    font-size: 16px !important;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23CF9524' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
    background-repeat: no-repeat !important;
    background-position: right 15px center !important;
    background-size: 16px !important;
}

#uidMensajero option {
    background: #0A0A0A !important;
    color: #F5F5F5 !important;
    padding: 10px !important;
    margin: 5px !important;
}



    </style>
</head>
<body>

    <!-- =================== ESTRUCTURA PRINCIPAL =================== -->

    <!-- Login View -->
    <div id="login-view" class="login-container">
        <div class="login-card">
            <div class="logo-container">
                <img src="https://raymessco.github.io/app_raymessco/icon-192.png" class="logo" alt="Ray Mess Co Logo">
                <h1 class="app-name">Ray Mess Co</h1>
                <p class="app-tagline">Sistema de gestión de servicios de mensajería</p>
            </div>
            
            <div id="auth-status" class="auth-status hidden"></div>
            
            <button id="btn-google" class="google-btn">
                <i class="fab fa-google"></i>
                <span id="btn-text">Continuar con Google</span>
                <div id="btn-loader" class="hidden">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </button>
            
            <p class="text-center mt-4 text-gold" style="font-size: 12px;">
                <i class="fas fa-info-circle"></i> Selecciona tu cuenta de Google para continuar
            </p>
        </div>
    </div>

    <!-- App View -->
    <div id="app" class="app-container hidden">
        <div class="app-header">
            <div class="header-left">
                <button id="sidebar-toggle" class="menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-logo">
                    <img src="https://raymessco.github.io/app_raymessco/icon-192.png" alt="Logo">
                    <span class="header-title">Ray Mess Co</span>
                </div>
                <span id="role-badge" class="role-badge">CLIENTE</span>
            </div>
            
            <div class="header-right">
                <span id="user-name" class="user-name"></span>
                <button id="btn-logout" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>

        <!-- Sidebar Backdrop -->
        <div id="sidebar-backdrop" class="sidebar-backdrop"></div>

        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Menú</h2>
                <button class="close-sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <!-- Registrar servicio -->
                <div id="menu-registrar" class="menu-item hidden" onclick="openModal(null)">
                    <i class="fas fa-plus-circle"></i>
                    <span class="menu-item-text">Registrar servicio</span>
                </div>
                
                <!-- Servicios -->
                <div class="menu-item" onclick="showSection('services')">
                    <i class="fas fa-clipboard-list"></i>
                    <span class="menu-item-text">Servicios</span>
                </div>

                <!-- Costos -->
                <div id="menu-costos" class="menu-item hidden" onclick="showSection('costos')">
                    <i class="fas fa-dollar-sign"></i>
                    <span class="menu-item-text">Costos por empresa</span>
                </div>

                <!-- Cobros -->
                <div id="menu-cobros" class="menu-item hidden" onclick="showSection('cobros')">
                    <i class="fas fa-cash-register"></i>
                    <span class="menu-item-text">Cobros contra entrega</span>
                </div>

                <!-- Solicitudes de mensajero -->
                <div id="menu-pendientes" class="menu-item hidden" onclick="showSection('pending-mensajeros')">
                    <i class="fas fa-user-clock"></i>
                    <span class="menu-item-text">Solicitudes mensajero</span>
                </div>

<!-- Archivar servicios e historial -->
<div id="menu-archivar" class="menu-item hidden" onclick="showSection('archivar')">
    <i class="fas fa-archive"></i>
    <span class="menu-item-text">Archivar servicios</span>
</div>

<div id="menu-historial" class="menu-item hidden" onclick="showSection('historial')">
    <i class="fas fa-history"></i>
    <span class="menu-item-text">Historial archivado</span>
</div>

                <!-- Finanzas mensajero -->
                <div id="menu-finanzas-mensajero" class="menu-item hidden" onclick="showSection('financial')">
                    <i class="fas fa-chart-line"></i>
                    <span class="menu-item-text">Mis Finanzas</span>
                </div>

                
                <!-- Editar perfil -->
                <div class="menu-item" onclick="openEditProfile()">
                    <i class="fas fa-user-edit"></i>
                    <span class="menu-item-text">Editar perfil</span>
                </div>
            </div>
        </div>

        <div class="main-content">
    <div id="pending-banner" class="hidden" style="background: rgba(161, 98, 7, 0.2); color: #FDE68A; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
        <i class="fas fa-clock"></i> Tu cuenta está en revisión para ser mensajero. Podrás usar funciones de mensajería una vez el administrador apruebe tu solicitud.
    </div>

    <div id="filters" class="filters-container">
        <button onclick="setFilter('all', this)" class="filter-btn active">Todos</button>
        <button onclick="setFilter('pendiente', this)" class="filter-btn">Pendientes</button>
        <button onclick="setFilter('en_ruta', this)" class="filter-btn">En ruta</button>
        <button onclick="setFilter('entregado', this)" class="filter-btn">Entregados</button>
        <button onclick="setFilter('cancelado', this)" class="filter-btn">Cancelados</button>
    </div>

    <div id="services-section" class="services-grid"></div>

    <div id="financial-section" class="hidden">
        <h2 class="section-title">Resumen financiero</h2>
        <div class="financial-card">
            <div class="financial-item">
                <span>Total ganado:</span>
                <span id="total-earned" class="text-gold">$0</span>
            </div>
            <div class="financial-item">
                <span>Total pendiente de pago:</span>
                <span id="total-pending" class="text-gold">$0</span>
            </div>
            <div class="financial-item">
                <span>Total pagado:</span>
                <span id="total-paid" class="text-gold">$0</span>
            </div>
        </div>
        <h3 class="section-title">Detalle de servicios por día</h3>
        <div id="financial-list"></div>
    </div>

    <div id="pending-mensajeros-section" class="hidden">
        <h2 class="section-title">Solicitudes de Mensajeros</h2>
        <div id="pending-mensajeros-list"></div>
    </div>

    <div id="costos-section" class="hidden">
        <h2 class="section-title">Costos por empresa</h2>
        <div id="costos-empresas"></div>
    </div>

    <div id="cobros-section" class="hidden">
        <h2 class="section-title">Cobros contra entrega</h2>
        <div id="cobros-body"></div>
    </div>

    <div id="archivar-section" class="hidden">
        <div class="archive-container">
            <div class="text-center mb-8">
                <h2 class="section-title">Archivar Servicios Antiguos</h2>
                <p class="text-gray-300">
                    Archiva automáticamente servicios en estado "entregado" o "cancelado" 
                    con más de 24 horas de antigüedad para mantener la base de datos organizada.
                </p>
            </div>
            
            <div class="archive-stats">
                <div class="archive-stat">
                    <span><i class="fas fa-check-circle text-green-400 mr-2"></i>Entregados:</span>
                    <span id="count-entregados" class="text-gold font-bold">0</span>
                </div>
                <div class="archive-stat">
                    <span><i class="fas fa-times-circle text-red-400 mr-2"></i>Cancelados:</span>
                    <span id="count-cancelados" class="text-gold font-bold">0</span>
                </div>
                <div class="archive-stat archive-stat-total">
                    <span><i class="fas fa-boxes text-gold mr-2"></i>Total a archivar:</span>
                    <span id="count-total" class="text-gold font-bold text-xl">0</span>
                </div>
            </div>
            
            <div class="archive-actions">
                <button onclick="loadArchivableServices()" class="archive-btn archive-btn-secondary">
                    <i class="fas fa-sync"></i> Actualizar Conteo
                </button>
                <button onclick="confirmArchive()" class="archive-btn archive-btn-primary">
                    <i class="fas fa-archive"></i> Archivar Ahora
                </button>
            </div>
            
            <div id="archive-progress" class="archive-progress hidden">
                <div class="text-center mb-4">
                    <i class="fas fa-spinner fa-spin text-gold mr-2"></i>
                    <span class="text-gold font-semibold">Procesando archivo...</span>
                </div>
                
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                </div>
                
                <div class="flex justify-between text-sm text-gray-300 mt-2">
                    <span id="progress-text">0/0 servicios</span>
                    <span id="progress-percent">0%</span>
                </div>
                
                <div class="text-center mt-4">
                    <button onclick="cancelArchive()" class="text-red-400 hover:text-red-300 text-sm">
                        <i class="fas fa-times"></i> Cancelar Proceso
                    </button>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-400">
                    <i class="fas fa-info-circle mr-1"></i> 
                    Los servicios archivados se moverán al historial y ya no aparecerán en la lista principal
                </p>
            </div>
        </div>
    </div>

    <div id="historial-section" class="hidden">
        <div class="text-center mb-8">
            <h2 class="section-title">Historial de Servicios Archivados</h2>
            <p class="text-gray-300 max-w-2xl mx-auto">
                Consulta todos los servicios que han sido archivados. Puedes filtrar por estado y exportar los datos.
            </p>
        </div>
    </div>

</div> </div> 


    
    <!-- Filtros corregidos -->
    <div class="filters-container mb-6">
        <button onclick="setHistorialFilter('all', this)" class="filter-btn active">
            <i class="fas fa-list mr-2"></i>Todos
        </button>
        <button onclick="setHistorialFilter('entregado', this)" class="filter-btn">
            <i class="fas fa-check mr-2"></i>Entregados
        </button>
        <button onclick="setHistorialFilter('cancelado', this)" class="filter-btn">
            <i class="fas fa-times mr-2"></i>Cancelados
        </button>
        <button onclick="exportHistorialToCSV()" class="filter-btn" style="background: #16a34a; color: white;">
            <i class="fas fa-download mr-2"></i> Exportar CSV
        </button>
    </div>
    
    <!-- Contenedor para los servicios del historial -->
    <div id="historial-list" class="services-grid"></div>
    
    <!-- Mensaje cuando no hay datos -->
    <div id="historial-empty" class="hidden text-center py-12">
        <i class="fas fa-inbox text-4xl text-gray-600 mb-4"></i>
        <p class="text-gray-400 text-lg">No hay servicios archivados</p>
        <p class="text-gray-500 text-sm">Los servicios aparecerán aquí después de ser archivados</p>
    </div>
</div>

    <!-- =================== MODALES =================== -->

    <!-- Modal de Servicio -->
    <div id="modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">✖</button>
            <h2 class="modal-title" id="modal-title">Nuevo Servicio</h2>

            <form id="service-form" onsubmit="handleServiceSubmit(event)">
                <!-- Empresa -->
                <div class="form-group">
                    <label for="empresaCliente" class="form-label">Empresa</label>
                    <input type="text" id="empresaCliente" name="empresaCliente" 
                           class="form-input" placeholder="Nombre de la empresa" />
                </div>

                <!-- Contacto -->
                <div class="form-group">
                    <label for="contacto" class="form-label">Contacto</label>
                    <input type="text" id="contacto" name="contacto"
                           class="form-input" placeholder="Persona de contacto" />
                </div>

                <!-- Teléfono -->
                <div class="form-group">
                    <label for="telefono" class="form-label">Teléfono</label>
                    <input type="text" id="telefono" name="telefono"
                           class="form-input" placeholder="Número de teléfono" />
                </div>

                <!-- Recoger -->
                <div class="form-group">
                    <label for="recoger" class="form-label">Dirección de recogida</label>
                    <input type="text" id="recoger" name="recoger"
                           class="form-input" placeholder="Dirección donde se recoge" />
                </div>

                <!-- Entregar -->
                <div class="form-group">
                    <label for="entregar" class="form-label">Dirección de entrega</label>
                    <input type="text" id="entregar" name="entregar"
                           class="form-input" placeholder="Dirección de entrega" />
                </div>

                <!-- Volumen -->
                <div class="form-group">
                    <label for="volumen" class="form-label">Volumen/Descripción</label>
                    <input type="text" id="volumen" name="volumen"
                           class="form-input" placeholder="Descripción del paquete" />
                </div>

                <!-- ✅ OBSERVACIONES -->
                <div class="form-group">
                    <label for="observaciones" class="form-label">Observaciones</label>
                    <textarea id="observaciones" name="observaciones" rows="3"
                              class="form-input" placeholder="Observaciones adicionales"></textarea>
                </div>

                <!-- ✅ PAGO AL MENSAJERO -->
                <div class="form-group">
                    <label for="pagoMensajero" class="form-label">Pago al mensajero</label>
                    <input type="number" id="pagoMensajero" name="pagoMensajero" 
                           step="100" min="0" class="form-input" placeholder="Valor a pagar al mensajero" />
                </div>

                <!-- Costo Cliente (solo para clientes) -->
                <div id="field-costo-cliente-container" class="form-group hidden">
                    <label for="costoCliente" class="form-label">Costo (Cliente)</label>
                    <input type="number" id="costoCliente" name="costoCliente" 
                           step="100" min="0" class="form-input" placeholder="Costo para el cliente" />
                </div>

                <!-- Campos de admin (solo para administradores) -->
                <div id="admin-fields" class="hidden">
                    <div class="form-group">
                        <label for="uidMensajero" class="form-label">Asignar mensajero</label>
                        <select id="uidMensajero" name="uidMensajero" class="form-input">
                            <option value="">Seleccionar mensajero</option>
                        </select>
                    </div>
                </div>

                <!-- Cobrar Producto -->
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="cobrar-check" name="cobrarCheck">
                        <label for="cobrar-check">Cobrar por producto</label>
                    </div>
                </div>

                <div id="cobrar-field-container" class="form-group hidden">
                    <label for="cobrarProducto" class="form-label">Valor a cobrar</label>
                    <input type="number" id="cobrarProducto" name="cobrarProducto" 
                           step="100" min="0" class="form-input" placeholder="Valor a cobrar al cliente" />
                </div>

                <!-- Botones -->
                <div class="form-actions">
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-save"></i> Guardar servicio
                    </button>
                    <button type="button" onclick="closeModal()" class="btn-cancel">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>

           
        </div>
    </div>

    <!-- Los demás modales (evidence, edit-profile, roleChoice) se mantienen igual -->
    <div id="evidence-modal" class="modal-backdrop hidden"> </div>


    <!-- Modal Editar Perfil - VERSIÓN COMPLETA -->
<div id="edit-profile-modal" class="modal-backdrop hidden">
    <div class="modal-content">
        <button class="modal-close" onclick="closeEditProfile()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="modal-header">
            <h2 class="modal-title">Editar perfil</h2>
        </div>
        
        <form id="profile-form">
            <div class="form-group">
                <label for="profile-displayName" class="form-label">Nombre para mostrar</label>
                <input type="text" id="profile-displayName" class="form-input" 
                       placeholder="Tu nombre" required maxlength="50">
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-submit">
                    <i class="fas fa-save"></i> Guardar cambios
                </button>
                <button type="button" onclick="closeEditProfile()" class="btn-cancel">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

    <div id="roleChoiceModal" class="modal-backdrop hidden">
        <!-- Contenido del modal de selección de rol -->
    </div>

    <button id="install-button" class="install-btn hidden">
        <i class="fas fa-download"></i> Instalar
    </button>

    <!-- =================== SCRIPTS =================== -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // Tu código JavaScript completo aquí...
        // [Todo el código JavaScript que tenías anteriormente]
        
        // Solo como ejemplo del inicio - el resto del código va completo
        const firebaseConfig = {
            apiKey: "AIzaSyCkjLdn1NYI5eApE4N5ylkGJnlYsmO5hq4",
            authDomain: "raymessco-ce1c0.firebaseapp.com",
            projectId: "raymessco-ce1c0",
            storageBucket: "raymessco-ce1c0.appspot.com",
            messagingSenderId: "829091900185",
            appId: "1:829091900185:web:1c61887780ff2639a5f388",
            measurementId: "G-38Q9K6CV7D"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
      console.log("Firebase v8 inicializado correctamente");

      // Estado global
      let currentUser = null;
      let currentRole = null;
      let services = [];
      let currentFilter = 'all';
      let _userProfileUnsub = null;
      let currentServiceIdForEvidence = null;
      let selectedPaymentMethod = null;
      let mensajerosList = [];
      let deferredPrompt = null;
      let _servicesUnsubscribe = null;

      // Referencias a elementos UI
      const loginView = document.getElementById('login-view');
      const appView = document.getElementById('app');
      const roleBadge = document.getElementById('role-badge');
      const userNameEl = document.getElementById('user-name');
      const menuRegistrar = document.getElementById('menu-registrar');
      const menuCostos = document.getElementById('menu-costos');
      const menuCobros = document.getElementById('menu-cobros');
      const menuPendientes = document.getElementById('menu-pendientes');
      const menuFinanzasMensajero = document.getElementById('menu-finanzas-mensajero');
      const roleChoiceModal = document.getElementById('roleChoiceModal');
      const sidebarBackdrop = document.getElementById('sidebar-backdrop');
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const closeSidebarBtn = document.querySelector('.close-sidebar');
      const fieldCostoClienteContainer = document.getElementById('field-costo-cliente-container');
      const adminFields = document.getElementById('admin-fields');
      const cobrarFieldContainer = document.getElementById('cobrar-field-container');
      const installButton = document.getElementById('install-button');
      const mensajeroSelect = document.getElementById('field-mensajero');

      // Inicializar la aplicación
     function initApp() {
  const sidebarToggle = document.getElementById('sidebar-toggle');
  const closeSidebarBtn = document.querySelector('.close-sidebar');
  const sidebarBackdrop = document.getElementById('sidebar-backdrop');
  const sidebar = document.getElementById('sidebar');
  const installButton = document.getElementById('install-button');

  // Sidebar
  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', toggleSidebar);
  }
  if (closeSidebarBtn) {
    closeSidebarBtn.addEventListener('click', toggleSidebar);
  }
  if (sidebarBackdrop) {
    sidebarBackdrop.addEventListener('click', toggleSidebar);
  }

  // Cobrar producto
  const cobrarCheck = document.getElementById('cobrar-check');
  const cobrarFieldContainer = document.getElementById('cobrar-field-container');
  if (cobrarCheck) {
    cobrarCheck.addEventListener('change', (e) => {
      cobrarFieldContainer.classList.toggle('hidden', !e.target.checked);
    });
  }

  // Formularios
  const serviceForm = document.getElementById('service-form');
if (serviceForm) {
  serviceForm.addEventListener('submit', handleServiceSubmit);
}

  const profileForm = document.getElementById('profile-form');
if (profileForm) {
  profileForm.addEventListener('submit', handleProfileUpdate);
}


  // Botón logout
 const logoutBtn = document.getElementById('btn-logout');
if (logoutBtn) {
  logoutBtn.addEventListener('click', () => auth.signOut());
}

  // Botón Google
  const googleBtn = document.getElementById('btn-google');
if (googleBtn) {
  googleBtn.addEventListener('click', signInWithGoogle);
}

  // Instalar PWA
  if (installButton) {
  installButton.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      installButton.classList.add('hidden');
    }
    deferredPrompt = null;
  });
}

  // Capturar evidencia
  const captureBtn = document.getElementById('capture-btn');
  if (captureBtn) {
    captureBtn.addEventListener('click', () => {
      const video = document.getElementById('videoElement');
      const canvas = document.getElementById('canvasElement');
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      document.getElementById('capturedImage').src = canvas.toDataURL('image/jpeg');
      document.getElementById('captured-image-container').classList.remove('hidden');
      document.getElementById('videoElement').classList.add('hidden');
      document.getElementById('capture-btn').classList.add('hidden');
      document.getElementById('confirm-delivery').disabled = false;
    });
  }

  const retakeBtn = document.getElementById('retake-btn');
  if (retakeBtn) {
    retakeBtn.addEventListener('click', () => {
      document.getElementById('captured-image-container').classList.add('hidden');
      document.getElementById('videoElement').classList.remove('hidden');
      document.getElementById('capture-btn').classList.remove('hidden');
      document.getElementById('confirm-delivery').disabled = true;
    });
  }

  const confirmDelivery = document.getElementById('confirm-delivery');
if (confirmDelivery) {
  confirmDelivery.addEventListener('click', async () => {
    if (!selectedPaymentMethod) {
      alert('Por favor selecciona un método de pago');
      return;
    }

    try {
      await db.collection('services').doc(currentServiceIdForEvidence).update({
        estado: 'entregado',
        evidenciaEntrega: document.getElementById('capturedImage').src,
        metodoPago: selectedPaymentMethod,
        fechaEntrega: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('Entrega confirmada con éxito');
      closeEvidenceModal();
    } catch (error) {
      console.error('Error confirmando entrega:', error);
      alert('Error al confirmar la entrega');
    }
  });
}
}
 // ✅ cierre correcto de initApp()





      // Función para iniciar sesión con Google (Popup con fallback a Redirect)
  async function signInWithGoogle() {
    const btnText = document.getElementById('btn-text');
    const btnLoader = document.getElementById('btn-loader');

    btnText.textContent = 'Conectando...';
    btnLoader.classList.remove('hidden');
    showAuthStatus("Conectando con Google...", false);

    const provider = new firebase.auth.GoogleAuthProvider();

    try {
      // Primero intenta con popup (más fluido en la mayoría de navegadores)
      await auth.signInWithPopup(provider);
      console.log("Login exitoso con popup");
    } catch (error) {
      console.warn("Popup falló, usando redirect:", error);
      auth.signInWithRedirect(provider);
    }
  }


      // Manejar cambios en el estado de autenticación
      async function handleAuthStateChange(user) {
        if (!user) {
          // Usuario no autenticado
          currentUser = null;
          currentRole = null;
          services = [];
          appView.classList.add('hidden');
          loginView.classList.remove('hidden');
          
          cleanupListeners();
          
          // Ocultar loader del botón por si quedó visible
          document.getElementById('btn-text').textContent = 'Continuar con Google';
          document.getElementById('btn-loader').classList.add('hidden');

          return;
        }
        
        // Usuario autenticado
        loginView.classList.add('hidden');
        appView.classList.remove('hidden');
        currentUser = user;
        
        // Obtener información del perfil
        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            userNameEl.textContent = userData.displayName || user.displayName || user.email || '';
            currentRole = userData.role || 'cliente';
          } else {
            // Usuario nuevo, mostrar selector de rol
            userNameEl.textContent = user.displayName || user.email || '';
            showRoleSelection();
            return;
          }
        } catch (error) {
          console.error("Error obteniendo datos de usuario:", error);
          userNameEl.textContent = user.displayName || user.email || '';
          currentRole = 'cliente';
        }
        
        updateUIByRole();
        subscribeToUserProfile(user.uid);
        subscribeServicesByRole();
        
        if (currentRole === 'admin') {
          loadMensajerosList();
        }
        
        showSection('services');
      setFilter('all', this);

      }

      // --- El resto de tu lógica de la aplicación se mantiene sin cambios ---

      function cleanupListeners() {
        if (_userProfileUnsub) {
          _userProfileUnsub();
          _userProfileUnsub = null;
        }
        
        if (_servicesUnsubscribe) {
          _servicesUnsubscribe();
          _servicesUnsubscribe = null;
        }
      }

      function showRoleSelection() {
        roleChoiceModal.classList.remove('hidden');
      }

      async function selectRole(role) {
        try {
          await db.collection('users').doc(currentUser.uid).set({
            role: role === 'mensajero' ? 'pending_mensajero' : 'cliente',
            email: currentUser.email || '',
            displayName: currentUser.displayName || '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          currentRole = role === 'mensajero' ? 'pending_mensajero' : 'cliente';
          roleChoiceModal.classList.add('hidden');
          updateUIByRole();
          subscribeToUserProfile(currentUser.uid);
          subscribeServicesByRole();
        } catch (error) {
          console.error("Error guardando rol:", error);
          alert("Error al guardar la selección de rol. Intenta nuevamente.");
        }
      }
      window.selectRole = selectRole;

      function subscribeToUserProfile(uid) {
        if (_userProfileUnsub) {
          _userProfileUnsub();
          _userProfileUnsub = null;
        }
        
        const ref = db.collection('users').doc(uid);
        _userProfileUnsub = ref.onSnapshot(doc => {
          if (!doc.exists) return;
          
          const userData = doc.data();
          const newRole = userData.role;
          
          if (newRole && newRole !== currentRole) {
            currentRole = newRole;
            roleBadge.textContent = currentRole.toUpperCase();
            updateUIByRole();
            subscribeServicesByRole();
          }
          
          if (userData.displayName) {
            userNameEl.textContent = userData.displayName;
          }
        }, err => console.error('Error en listener de perfil:', err));
      }

     // OBSERVADOR DE AUTENTICACIÓN CORREGIDO
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          console.log("✅ Usuario autenticado:", user.email);

          try {
            // 1. Ocultar login, mostrar app
            document.getElementById("login-view").classList.add("hidden");
            document.getElementById("app").classList.remove("hidden");

            // 2. Buscar datos del usuario en Firestore por UID (IMPORTANTE)
            const userDoc = await db.collection('users').doc(user.uid).get();
            
            if (userDoc.exists) {
              const userData = userDoc.data();
              console.log("📋 Datos de usuario:", userData);
              
              // 3. Establecer rol y nombre globales
              currentRole = userData.role || 'cliente'; // Default to 'cliente' if role is missing
              currentUser = user;
              
              // 4. Actualizar la interfaz de usuario
              document.getElementById("user-name").textContent = 
                userData.displayName || user.displayName || user.email;
              
              document.getElementById("role-badge").textContent = 
                currentRole.toUpperCase().replace("_", " ");
              
              // 5. Configurar la visibilidad de los menús y funciones según el rol
            updateUIByRole();
subscribeServicesByRole();
// 6. Mostrar la sección de servicios por defecto
showSection('services');

// 7. Activar el filtro "Todos"
setFilter('all', document.querySelector('.filter-btn'));
              
              console.log("🎯 Rol detectado:", currentRole);
              
            } else {
              // Si el documento no existe, es un usuario nuevo, mostrar selector de rol
              console.log("👤 Usuario nuevo, mostrando selector de rol");
              showRoleSelection();
            }
            
          } catch (error) {
            console.error("❌ Error cargando datos de usuario:", error);
            // Si hay un error, mostrar la app como cliente para evitar que se bloquee
            currentRole = 'cliente';
            updateUIByRole();
          }

        } else {
          // Usuario no autenticado
          console.log("⚠️ Usuario no autenticado");
          document.getElementById("login-view").classList.remove("hidden");
          document.getElementById("app").classList.add("hidden");
          currentUser = null;
          currentRole = null;
        }
      });

// ✅ FUNCIÓN CORREGIDA Y EXTENDIDA PARA ACTUALIZAR LA INTERFAZ SEGÚN EL ROL
function updateUIByRole() {
  console.log("🔄 Actualizando UI para rol:", currentRole);
  
  // Referencias a los elementos del DOM existentes
  const menuCostos = document.getElementById("menu-costos");
  const menuCobros = document.getElementById("menu-cobros");
  const menuPendientes = document.getElementById("menu-pendientes");
  const menuFinanzasMensajero = document.getElementById("menu-finanzas-mensajero");
  const roleBadge = document.getElementById("role-badge");
  const pendingBanner = document.getElementById("pending-banner");
  const adminActions = document.getElementById("admin-actions");
  const filters = document.getElementById("filters");

  // ✅ Nuevos elementos
  const menuRegistrar = document.getElementById("menu-registrar");
  const adminFields = document.getElementById("admin-fields");
  const costoClienteField = document.getElementById("field-costo-cliente-container");

  // Función auxiliar para mostrar/ocultar elementos
  const hide = (el) => el && el.classList.add("hidden");
  const show = (el) => el && el.classList.remove("hidden");

  // Ocultar todos los elementos primero
  hide(menuCostos);
    hide(menuCobros);
    hide(menuPendientes);
    hide(menuFinanzasMensajero);
    hide(pendingBanner);
    hide(adminActions);
    hide(menuRegistrar);
    hide(adminFields);
    hide(costoClienteField);

     // 🔥 NUEVO: Ocultar los nuevos menús primero
    const menuArchivar = document.getElementById("menu-archivar");
    const menuHistorial = document.getElementById("menu-historial");
    hide(menuArchivar);
    hide(menuHistorial);

  // Mostrar filtros por defecto (para la sección de servicios)
  if (filters) {
    show(filters);
  }

  // Configurar según el rol
    switch (currentRole) {
        case "admin":
            console.log("🔓 Configurando interfaz ADMIN");
            show(menuCostos);
            show(menuCobros);
            show(menuPendientes);
            show(adminActions);
            show(menuRegistrar);
            show(adminFields);
            show(costoClienteField);
            // 🔥 NUEVO: Mostrar menús de archivar/historial para admin
            show(menuArchivar);
            show(menuHistorial);
            break;

    case "mensajero":
      console.log("🚴 Configurando interfaz MENSAJERO");
      show(menuFinanzasMensajero);
      // los mensajeros no ven registrar ni campos admin
      break;

    case "pending_mensajero":
      console.log("⏳ Configurando interfaz MENSAJERO PENDIENTE");
      show(pendingBanner);
      break;

    default: // cliente
      console.log("👤 Configurando interfaz CLIENTE");
      show(menuRegistrar);  // 👈 cliente puede registrar
      // cliente no ve admin fields ni costo cliente
      break;
  }

  // Actualizar el badge del rol
  if (roleBadge) {
    roleBadge.textContent = currentRole.toUpperCase().replace("_", " ");
    console.log("🏷️ Badge actualizado:", roleBadge.textContent);
  }
}

// Hacerla disponible globalmente
window.updateUIByRole = updateUIByRole;


// Agrega esta función de diagnóstico al final de tu script
function diagnoseUI() {
  console.log("🔍 DIAGNÓSTICO DE INTERFAZ:");
  console.log("currentRole:", currentRole);
  console.log("currentUser:", currentUser ? currentUser.email : "null");
  
  const elementsToCheck = [
    'menu-costos', 'menu-cobros', 'menu-pendientes', 
    'menu-finanzas-mensajero', 'admin-actions', 'role-badge'
  ];
  
  elementsToCheck.forEach(id => {
    const el = document.getElementById(id);
    console.log(`${id}:`, el ? (el.classList.contains('hidden') ? 'OCULTO' : 'VISIBLE') : 'NO ENCONTRADO');
  });
}

// Llama a esta función después de updateUIByRole() en el observador
diagnoseUI();

      function toggleSidebar() {
        sidebar.classList.toggle('open');
        sidebarBackdrop.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
      }
      window.toggleSidebar = toggleSidebar;

      function showAuthStatus(message, isError = false) {
        const statusEl = document.getElementById('auth-status');
        statusEl.textContent = message;
        statusEl.classList.remove('hidden', 'success', 'error');
        statusEl.classList.add(isError ? 'error' : 'success');
        
        setTimeout(() => {
          statusEl.classList.add('hidden');
        }, 5000);
      }

     function openModal(editId = null) {
    console.log("🎯 openModal() INICIADO - editId:", editId);
    
    const modal = document.getElementById('modal');
    const form = document.getElementById('service-form');
    
    if (!modal || !form) {
        console.error("❌ No se encontró el modal o el formulario");
        return;
    }
    
    form.reset();
    form.dataset.editId = editId || '';
    
    // Actualizar título del modal
    const modalTitle = document.querySelector('.modal-title');
    if (modalTitle) {
        modalTitle.textContent = editId ? 'Editar Servicio' : 'Nuevo Servicio';
    }
    
    if (currentRole === 'mensajero' || currentRole === 'pending_mensajero') {
        console.log("⏩ Usuario no autorizado para abrir modal");
        return;
    }
    
    // ✅ CORREGIDO: LLAMAR EXPLÍCITAMENTE loadMensajerosList() para admin
    console.log("🔍 Rol actual al abrir modal:", currentRole);
    if (currentRole === 'admin') {
        console.log("🎯 Ejecutando loadMensajerosList() para admin");
        loadMensajerosList(); // 👈 ESTA LÍNEA DEBE EJECUTARSE
    } else {
        console.log("👤 Usuario no admin, no se cargan mensajeros");
    }
    
    if (editId) {
        console.log("📝 Editando servicio:", editId);
        const service = services.find(x => x.id === editId);
        if (service) {
            console.log("✅ Servicio encontrado para editar:", service);
            // ... resto del código de edición
            form.empresaCliente.value = service.empresa || service.cliente || '';
            form.contacto.value = service.contacto || '';
            form.telefono.value = service.telefono || '';
            form.recoger.value = service.recoger || '';
            form.entregar.value = service.entregar || '';
            form.volumen.value = service.volumen || '';
            form.observaciones.value = service.observaciones || '';
            form.pagoMensajero.value = service.pagoMensajero || 0;
            
            if (currentRole === 'admin') {
                // Esperar a que se carguen los mensajeros antes de seleccionar
                setTimeout(() => {
                    const mensajeroSelect = document.getElementById('uidMensajero');
                    if (mensajeroSelect) {
                        mensajeroSelect.value = service.uidMensajero || '';
                        console.log("🎯 Mensajero seleccionado:", service.uidMensajero);
                    }
                }, 1000);
            } else {
                form.costoCliente.value = service.costo || 0;
            }
            
            if (service.cobrarProducto && service.cobrarProducto > 0) {
                document.getElementById('cobrar-check').checked = true;
                document.getElementById('cobrar-field-container').classList.remove('hidden');
                form.cobrarProducto.value = service.cobrarProducto;
            }
        }
    }
    
    modal.classList.remove('hidden');
    console.log("✅ Modal abierto correctamente");
}
      window.openModal = openModal;

      function closeModal() {
        document.getElementById('modal').classList.add('hidden');
      }
      window.closeModal = closeModal;

  function normalizeColombiaPhone(phone) {
    if (!phone) return "";

    // Quitar todo lo que no sea número
    let digits = String(phone).replace(/\D/g, "");

    // Eliminar ceros iniciales
    digits = digits.replace(/^0+/, "");

    // Si ya empieza por 57, dejarlo así
    if (digits.startsWith("57")) return digits;

    // Si tiene 10 dígitos y empieza con 3, es celular -> agregar 57
    if (digits.length === 10 && digits.startsWith("3")) {
      return "57" + digits;
    }

    // Si tiene entre 7 y 12 dígitos, agregar 57
    if (digits.length >= 7 && digits.length <= 12) {
      return "57" + digits;
    }

    return digits; // fallback
  }


   async function handleServiceSubmit(e) {
  e.preventDefault();

  if (!(currentRole === 'admin' || currentRole === 'cliente')) {
    alert('No tienes permisos para crear pedidos hasta que tu cuenta sea aprobada.');
    return;
  }

  const form = e.target;
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());
  const docId = form.dataset.editId || null;

  const telefonoNormalizado = normalizeColombiaPhone(data.telefono);

  // Payload base común
  const payload = {
    empresa: data.empresaCliente || "",
  cliente: currentUser.displayName || currentUser.email || "Sin nombre",
  contacto: data.contacto || "",
  recoger: data.recoger || "",
  entregar: data.entregar || "",
  barrioMunicipio: data.barrioMunicipio || "",
  telefono: telefonoNormalizado || "",
  volumen: data.volumen || "",
  observaciones: data.observaciones || "",   // 👈 ya capturado
  cobrarProducto: parseFloat(data.cobrarProducto || 0) || 0,
  pagoMensajero: parseFloat(data.pagoMensajero || 0) || 0, // 👈 nuevo campo
  uidCliente: currentUser.uid,
  emailCliente: currentUser.email || "",
  estado: "pendiente",
  fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
};

  // Configuración según rol
  if (currentRole === 'admin') {
    payload.uidMensajero = data.uidMensajero || "";
    payload.pagoMensajero = parseFloat(data.pagoMensajero || 0) || 0;
    payload.costo = parseFloat(data.pagoMensajero || 0) || 0;
  } else if (currentRole === 'cliente') {
    payload.pagoMensajero = parseFloat(data.pagoMensajero || 0) || 0; // ✅ cliente también lo guarda
    payload.costo = parseFloat(data.costoCliente || 0) || 0;
  }

  console.log("FieldValue timestamp:", firebase.firestore.FieldValue.serverTimestamp);
  console.log("fechaCreacion:", payload.fechaCreacion);
  console.log("Payload inicial:", JSON.stringify(payload, null, 2));

  try {
    if (docId) {
      console.log("📝 Actualizando servicio");

      const updateData = { ...payload };
      delete updateData.fechaCreacion;

      const simpleUpdateData = {};
      Object.keys(updateData).forEach(key => {
        if (updateData[key] !== undefined && updateData[key] !== null) {
          simpleUpdateData[key] = updateData[key];
        }
      });

      await db.collection('services').doc(docId).update(simpleUpdateData);

      const updatedDoc = await db.collection('services').doc(docId).get();
      const updatedDataResult = { id: updatedDoc.id, ...updatedDoc.data() };

      services = services.map(s => (s.id === updatedDataResult.id ? updatedDataResult : s));
      renderServices(services);

      console.log("✅ Servicio actualizado correctamente:", updatedDataResult.id);

    } else {
      console.log("➕ Creando nuevo servicio");
      payload.estado = "pendiente";
      payload.fechaCreacion = firebase.firestore.FieldValue.serverTimestamp();

      const docRef = await db.collection('services').add(payload);
      const newDoc = await docRef.get();
      const newData = { id: newDoc.id, ...newDoc.data() };

      services.unshift(newData);

      console.log("✅ Servicio creado correctamente:", newData.id);
    }

    closeModal();
    form.reset();

  } catch (error) {
    console.error("❌ Error guardando servicio:", error);
    alert("Error guardando servicio. Verifica que tengas los permisos necesarios.");
  }
}

async function loadMensajerosList() {
    try {
        const mensajeroSelect = document.getElementById('uidMensajero');
        if (!mensajeroSelect) return;

        const mensajerosSnapshot = await db.collection('users')
            .where('role', 'in', ['mensajero', 'admin'])
            .get();

        mensajeroSelect.innerHTML = '<option value="">Seleccionar mensajero</option>';

        if (mensajerosSnapshot.empty) {
            mensajeroSelect.innerHTML = '<option value="">No hay mensajeros disponibles</option>';
            return;
        }

        mensajerosSnapshot.forEach(doc => {
            const data = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = data.displayName || data.email || doc.id;
            mensajeroSelect.appendChild(option);
        });

    } catch (error) {
        console.error('Error cargando mensajeros:', error);
        const mensajeroSelect = document.getElementById('uidMensajero');
        if (mensajeroSelect) {
            mensajeroSelect.innerHTML = '<option value="">Error al cargar</option>';
        }
    }
}


      function subscribeServicesByRole() {
    const servicesEl = document.getElementById('services-section');
    servicesEl.innerHTML = '<div class="text-center text-gold">Cargando servicios...</div>';

    // Cancelar cualquier suscripción anterior
    if (_servicesUnsubscribe) {
      try { _servicesUnsubscribe(); } catch (e) { console.warn("Error al cancelar suscripción anterior:", e); }
      _servicesUnsubscribe = null;
    }

    if (!currentUser || !currentRole) {
      servicesEl.innerHTML = '<div class="text-center text-gold">Esperando datos de usuario...</div>';
      return;
    }

    // ===== ADMIN =====
    if (currentRole === 'admin') {
    const query = db.collection('services').orderBy('fechaCreacion', 'desc');

    _servicesUnsubscribe = query.onSnapshot(snapshot => {
      const allServices = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      console.log("Servicios obtenidos (admin):", allServices);
      renderServices(allServices);
    }, err => {
      console.error("Error snapshot admin:", err);
      servicesEl.innerHTML = '<div class="text-center text-gold">Error cargando servicios.</div>';
    });

    return;
  }


    // ===== CLIENTE =====
    if (currentRole === 'cliente') {
      console.log("UID actual del cliente:", currentUser.uid);

      const query = db.collection('services')
                      .where('uidCliente', '==', currentUser.uid)
                      .orderBy('fechaCreacion', 'desc');

      _servicesUnsubscribe = query.onSnapshot(snapshot => {
        const allServices = snapshot.docs.map
        (doc => ({ id: doc.id, ...doc.data() }));

        console.log("Servicios obtenidos (cliente):", allServices);
        renderServices(allServices);
      }, err => {
        console.error("Error snapshot cliente:", err);
        servicesEl.innerHTML = '<div class="text-center text-gold">Error cargando tus pedidos.</div>';
      });
      return;
    }

    // ===== MENSAJERO =====
    if (currentRole === 'mensajero') {
      const pendientesQuery = db.collection('services').where('estado', '==', 'pendiente');
      const propiosQuery = db.collection('services').where('uidMensajero', '==', currentUser.uid);

      let pendientesCache = [];
      let propiosCache = [];

      function combineAndRender() {
        const combined = [
          ...pendientesCache,
          ...propiosCache.filter(p => !pendientesCache.find(pd => pd.id === p.id))
        ];

        combined.sort((a, b) => {
          const at = a.fechaCreacion?.seconds || 0;
          const bt = b.fechaCreacion?.seconds || 0;
          return bt - at;
        });

        console.log("Servicios combinados para mensajero:", combined);
        renderServices(combined);
      }

      const unsubPendientes = pendientesQuery.onSnapshot(snapshot => {
        pendientesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        combineAndRender();
      }, err => {
        console.error("Error snapshot pendientes:", err);
      });

      const unsubPropios = propiosQuery.onSnapshot(snapshot => {
        propiosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        combineAndRender();
      }, err => {
        console.error("Error snapshot propios:", err);
      });

      // Guardar función que cancela ambos listeners
      _servicesUnsubscribe = () => {
        try { unsubPendientes(); } catch (e) {}
        try { unsubPropios(); } catch (e) {}
      };

      return;
    }

    // ===== MENSAJERO EN REVISIÓN =====
    if (currentRole === 'pending_mensajero') {
      servicesEl.innerHTML = '<div class="text-center text-gold">Tu cuenta está en revisión. No puedes ver servicios aún.</div>';
      return;
    }

    // ===== ROL DESCONOCIDO =====
    servicesEl.innerHTML = '<div class="text-center text-gold">Rol no reconocido</div>';
  }

function renderServices(data) {
    const servicesEl = document.getElementById('services-section');
    if (!servicesEl) return;

    // Si se pasan datos nuevos, actualizar la lista global
    if (data !== undefined) {
        services = data;
    }

    // Si no hay servicios, mostrar mensaje
    if (!services || services.length === 0) {
        servicesEl.innerHTML = '<div class="text-center text-gold">No hay servicios para mostrar</div>';
        return;
    }

    // 🔥 FILTRAR SERVICIOS SEGÚN currentFilter
    let filteredServices = services;
    
    if (currentFilter && currentFilter !== 'all') {
        filteredServices = services.filter(service => {
            const estado = (service.estado || '').toLowerCase();
            const filtro = currentFilter.toLowerCase();
            return estado === filtro;
        });
    }

    console.log(`Filtro aplicado: ${currentFilter}`);
    console.log(`Servicios totales: ${services.length}, Filtrados: ${filteredServices.length}`);

    // Si el filtro no tiene resultados
    if (filteredServices.length === 0) {
        servicesEl.innerHTML = `<div class="text-center text-gold">No hay servicios con estado '${currentFilter}'</div>`;
        return;
    }

    // Limpiar el contenedor antes de renderizar
    servicesEl.innerHTML = '';

    // Renderizar servicios filtrados
    filteredServices.forEach(service => {
        const serviceCard = document.createElement('div');
        serviceCard.className = 'service-card';

        let actionsHTML = '';
        let statusClass = `status-${(service.estado || '').replace('_', '')}`;

        // --- Fecha de creación ---
        let fechaCreacion = 'Fecha no disponible';
        if (service.fechaCreacion && typeof service.fechaCreacion.toDate === 'function') {
            fechaCreacion = service.fechaCreacion.toDate().toLocaleString('es-CO');
        }

        // --- Fecha de entrega ---
        let fechaEntregaHTML = '';
        if (service.fechaEntrega && typeof service.fechaEntrega.toDate === 'function') {
            fechaEntregaHTML = `
                <div class="service-date">
                    <i class="fas fa-calendar-check"></i> Entregado: ${service.fechaEntrega.toDate().toLocaleString('es-CO')}
                </div>
            `;
        }

        // --- Evidencia y método de pago ---
        let evidenciaHTML = '';
        if (service.estado === 'entregado' && currentRole === 'cliente') {
            if (service.evidenciaEntrega) {
                evidenciaHTML = `
                    <div class="service-detail">
                        <i class="fas fa-image"></i>
                        <div class="service-detail-content">
                            <strong>Evidencia de entrega:</strong><br>
                            <button onclick="openEvidenceView('${service.evidenciaEntrega}')"
                                    class="text-blue-600 underline hover:text-blue-800">
                                Ver foto de evidencia
                            </button>
                        </div>
                    </div>
                `;
            }

            if (service.metodoPago) {
                evidenciaHTML += `
                    <div class="service-detail">
                        <i class="fas fa-credit-card"></i>
                        <div class="service-detail-content">
                            <strong>Método de pago:</strong> ${service.metodoPago}
                        </div>
                    </div>
                `;
            }
        }

        // --- Acciones según estado y rol ---
        switch (service.estado) {
            case 'pendiente':
                if (currentRole === 'mensajero') {
                    actionsHTML = `<button class="btn-primary action-btn" onclick="takeService('${service.id}')">Tomar servicio</button>`;
                } else if (currentRole === 'admin' || currentRole === 'cliente') {
                    actionsHTML = `
                        <button class="btn-secondary action-btn" onclick="openModal('${service.id}')">Editar</button>
                        <button class="btn-danger action-btn" onclick="deleteService('${service.id}')">Eliminar</button>
                    `;
                }
                break;

            case 'en_ruta':
                if (currentRole === 'mensajero' && service.uidMensajero === currentUser.uid) {
                    actionsHTML = `
                        <button class="btn-primary action-btn" onclick="openEvidenceModal('${service.id}')">Tomar evidencia</button>
                        <button class="btn-success action-btn" onclick="changeEstado('${service.id}', 'entregado')">Marcar como entregado</button>
                        <button class="btn-danger action-btn" onclick="changeEstado('${service.id}', 'cancelado')">Cancelar</button>
                    `;
                } else if (currentRole === 'admin') {
                    actionsHTML = `
                        <button class="btn-secondary action-btn" onclick="openModal('${service.id}')">Editar</button>
                        <button class="btn-danger action-btn" onclick="deleteService('${service.id}')">Eliminar</button>
                    `;
                }
                break;

            case 'entregado':
                if (currentRole === 'admin') {
                    actionsHTML = `<button class="btn-secondary action-btn" onclick="openModal('${service.id}')">Ver detalles</button>`;
                } else if (currentRole === 'cliente' && service.uidCliente === currentUser.uid) {
                    actionsHTML = `<span class="text-green-700 font-semibold">Servicio entregado</span>`;
                } else if (currentRole === 'mensajero' && service.uidMensajero === currentUser.uid) {
                    actionsHTML = `<span class="text-green-700 font-semibold">Has completado este servicio</span>`;
                }
                break;

            case 'cancelado':
                if (currentRole === 'admin') {
                    actionsHTML = `<button class="btn-secondary action-btn" onclick="openModal('${service.id}')">Ver detalles</button>`;
                } else if (currentRole === 'cliente' && service.uidCliente === currentUser.uid) {
                    actionsHTML = `<span class="text-red-600 font-semibold">Servicio cancelado</span>`;
                } else if (currentRole === 'mensajero' && service.uidMensajero === currentUser.uid) {
                    actionsHTML = `<span class="text-red-600 font-semibold">Has cancelado este servicio</span>`;
                }
                break;
        }

        // --- Plantilla final del servicio ---
        const telefono = service.telefono || '';
        const telefonoNormalized = normalizeColombiaPhone(telefono);

        serviceCard.innerHTML = `
            <div class="service-header">
                <div class="service-client">${service.empresa || service.cliente || 'Sin nombre'}</div>
                <div class="service-status ${statusClass}">${(service.estado || '').replace('_', ' ')}</div>
            </div>

            <div class="service-detail">
                <i class="fas fa-user"></i>
                <div class="service-detail-content">${service.contacto || 'No especificado'}</div>
            </div>

            <!-- Teléfono con WhatsApp y llamada -->
            <div class="service-detail flex items-center gap-4 mt-2">
                <i class="fas fa-phone text-xl text-gold"></i>
                <div class="service-detail-content flex items-center gap-4">
                    <span class="font-medium">${service.telefono}</span>

                    <!-- WhatsApp -->
                    <a href="https://wa.me/${telefonoNormalized}" 
                        target="_blank" 
                        aria-label="Chatear por WhatsApp"
                        class="flex items-center justify-center w-10 h-10 rounded-full bg-green-600 hover:bg-green-700 text-white shadow">
                        <i class="fab fa-whatsapp text-2xl"></i>
                    </a>

                    <!-- Llamar -->
                    <a href="tel:${service.telefono}" 
                        aria-label="Llamar por teléfono"
                        class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow">
                        <i class="fas fa-phone-alt text-2xl"></i>
                    </a>
                </div>
            </div>

            <div class="service-detail">
                <i class="fas fa-map-marker-alt"></i>
                <div class="service-detail-content">
                    <div><strong>Recoger:</strong> ${service.recoger || 'No especificado'}</div>
                    <div class="flex items-center gap-2">
                        <strong>Entregar:</strong> 
                        <span>${service.entregar || 'No especificado'}</span>
                        ${service.entregar ? `
                            <button 
                                onclick="openInGoogleMaps('${service.entregar}')"
                                class="btn-maps ml-2 flex items-center justify-center w-10 h-10 rounded-full bg-gold hover:bg-yellow-500 text-black shadow"
                                title="Abrir en Google Maps">
                                <i class="fas fa-map-marked-alt text-xl"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>

            ${service.volumen ? `<div class="service-detail"><i class="fas fa-box"></i><div class="service-detail-content">${service.volumen}</div></div>` : ''}
            ${service.observaciones ? `<div class="service-detail"><i class="fas fa-sticky-note"></i><div class="service-detail-content">${service.observaciones}</div></div>` : ''}

            <!-- 💰 Pago al mensajero siempre mostrado -->
            <div class="service-detail">
                <i class="fas fa-motorcycle"></i>
                <div class="service-detail-content">
                    Pago al mensajero: ${Number(service.pagoMensajero || 0).toLocaleString()}
                </div>
            </div>

            ${(service.costo && service.costo > 0) ? `<div class="service-detail"><i class="fas fa-dollar-sign"></i><div class="service-detail-content">Costo: ${service.costo.toLocaleString()}</div></div>` : ''}
            ${(service.cobrarProducto && service.cobrarProducto > 0) ? `<div class="service-detail"><i class="fas fa-cash-register"></i><div class="service-detail-content">Cobrar: ${service.cobrarProducto.toLocaleString()}</div></div>` : ''}

            <div class="service-date">
                <i class="fas fa-calendar"></i> Creado: ${fechaCreacion}
            </div>

            ${fechaEntregaHTML}
            ${evidenciaHTML}
            ${actionsHTML ? `<div class="service-actions">${actionsHTML}</div>` : ''}
        `;

        console.log("Pintando servicio:", service);
        servicesEl.appendChild(serviceCard);
    });

    console.log("📦 Contenido actual de #services-section:", servicesEl.innerHTML);
}


// CORRECCIÓN: Inicialización simple sin skeleton
document.addEventListener('DOMContentLoaded', function() {
    initApp();
});

  // Abre el modal y muestra la foto
  function openEvidenceView(imageUrl) {
    document.getElementById('evidence-view-img').src = imageUrl;
    document.getElementById('evidence-view-modal').classList.remove('hidden');
  }
  window.openEvidenceView = openEvidenceView;

  // Cierra el modal
  function closeEvidenceView() {
    document.getElementById('evidence-view-modal').classList.add('hidden');
    document.getElementById('evidence-view-img').src = '';
  }
  window.closeEvidenceView = closeEvidenceView;

        

        function takeService(serviceId) {
    if (!currentUser) return alert("Debes iniciar sesión para tomar un servicio");

    db.collection("services").doc(serviceId).update({
      uidMensajero: currentUser.uid,
      estado: "en_ruta"
    })
    .then(() => {
      console.log("Servicio tomado correctamente");
    })
    .catch(error => {
      console.error("Error al tomar servicio:", error);
      alert("No se pudo tomar el servicio. Intenta de nuevo.");
    });
  }
      
  function openInGoogleMaps(address) {
    if (!address) {
      alert("No hay dirección disponible para esta entrega.");
      return;
    }

    // Codifica la dirección para usarla en la URL de Google Maps
    const encodedAddress = encodeURIComponent(address);

    // Abre Google Maps en una nueva pestaña
    window.open(`https://www.google.com/maps/search/?api=1&query=${encodedAddress}`, '_blank');
  }
  window.openInGoogleMaps = openInGoogleMaps;


  // === Normalizar teléfono Colombia ===
  function normalizeColombiaPhone(phone) {
    if (!phone) return "";

    // Quitar todo lo que no sean dígitos
    let digits = String(phone).replace(/\D/g, "");

    // Eliminar ceros iniciales
    digits = digits.replace(/^0+/, "");

    // Si ya empieza por 57, devolver tal cual
    if (digits.startsWith("57")) return digits;

    // Si es un celular colombiano (empieza con 3 y tiene 10 dígitos)
    if (digits.length === 10 && digits.startsWith("3")) {
      return "57" + digits;
    }

    // Para cualquier otro caso, si tiene entre 7 y 12 dígitos, agregar 57
    if (digits.length >= 7 && digits.length <= 12) {
      return "57" + digits;
    }

    // En caso extremo, devolver los dígitos como estén
    return digits;
  }

  // === Teléfono para href tel:+57...
  function formatTelHref(phone) {
    const norm = normalizeColombiaPhone(phone);
    return norm ? `+${norm}` : "";
  }

  // === Abrir chat de WhatsApp ===
  function openWhatsApp(phone) {
    const digits = normalizeColombiaPhone(phone);
    if (!digits) {
      alert("Número inválido para WhatsApp.");
      return;
    }
    window.open(`https://wa.me/${digits}`, "_blank");
  }
  window.openWhatsApp = openWhatsApp;

  // === Llamar directamente ===
  function callPhone(phone) {
    const href = formatTelHref(phone);
    if (!href) {
      alert("Número de teléfono inválido.");
      return;
    }
    window.location.href = `tel:${href}`;
  }
  window.callPhone = callPhone;

  // === Formatear automáticamente el input de teléfono al perder foco ===
  function attachPhoneAutoFormat(inputElement) {
    if (!inputElement) return;
    inputElement.addEventListener("blur", () => {
      const raw = inputElement.value || "";
      const digits = normalizeColombiaPhone(raw);
      if (digits) {
        inputElement.value = "+" + digits; // Mostrar con +
      }
    });
  }
  window.attachPhoneAutoFormat = attachPhoneAutoFormat;

function cancelArchive() {
    // Esta función cancelaría el proceso de archivado si estuviera en curso
    document.getElementById('archive-progress').classList.add('hidden');
    alert('Proceso de archivado cancelado');
}
window.cancelArchive = cancelArchive;


      async function changeEstado(serviceId, newEstado) {
        if (!confirm(`¿Estás seguro de que deseas cambiar el estado a '${newEstado}'?`)) return;
        try {
          await db.collection('services').doc(serviceId).update({ estado: newEstado });
          alert(`Servicio actualizado a '${newEstado}'`);
        } catch (error) {
          console.error('Error cambiando estado:', error);
          alert('Error al cambiar el estado del servicio');
        }
      }
      window.changeEstado = changeEstado;

      async function takeService(serviceId) {
        try {
          await db.collection('services').doc(serviceId).update({
            estado: 'en_ruta',
            uidMensajero: currentUser.uid
          });
          alert('Servicio tomado con éxito');
        } catch (error) {
          console.error('Error tomando servicio:', error);
          alert('Error al tomar el servicio');
        }
      }
      window.takeService = takeService;

      async function deleteService(serviceId) {
        if (!confirm('¿Estás seguro de que deseas eliminar este servicio?')) return;
        
        try {
          await db.collection('services').doc(serviceId).delete();
          alert('Servicio eliminado con éxito');
        } catch (error) {
          console.error('Error eliminando servicio:', error);
          alert('Error al eliminar el servicio');
        }
      }
      window.deleteService = deleteService;

      function openEvidenceModal(serviceId) {
        currentServiceIdForEvidence = serviceId;
        document.getElementById('evidence-modal').classList.remove('hidden');
        startCamera();
      }
      window.openEvidenceModal = openEvidenceModal;

      function closeEvidenceModal() {
        document.getElementById('evidence-modal').classList.add('hidden');
        stopCamera();
        resetEvidenceModal();
      }
      window.closeEvidenceModal = closeEvidenceModal;

      async function startCamera() {
    const videoElement = document.getElementById('videoElement');

    try {
      // Intentar con la cámara trasera
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" } },
        audio: false
      });

      videoElement.srcObject = stream;
      videoElement.play();
      console.log("📷 Cámara trasera activada");
    } catch (error) {
      console.warn("⚠️ No se pudo usar la cámara trasera, intentando cámara por defecto:", error);

      // Si falla, usar la cámara predeterminada
      try {
        const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoElement.srcObject = fallbackStream;
        videoElement.play();
        console.log("📷 Cámara predeterminada activada");
      } catch (fallbackError) {
        console.error("❌ No se pudo acceder a ninguna cámara:", fallbackError);
        alert("No se pudo acceder a la cámara. Revisa los permisos en tu navegador.");
      }
    }
  }
  window.startCamera = startCamera;

      function stopCamera() {
        const videoElement = document.getElementById('videoElement');
        if (videoElement.srcObject) {
          videoElement.srcObject.getTracks().forEach(track => track.stop());
          videoElement.srcObject = null;
        }
      }

      function resetEvidenceModal() {
        document.getElementById('captured-image-container').classList.add('hidden');
        document.getElementById('videoElement').classList.remove('hidden');
        document.getElementById('capture-btn').classList.remove('hidden');
        document.querySelectorAll('input[name="paymentMethod"]').forEach(input => input.checked = false);
        selectedPaymentMethod = null;
        document.getElementById('confirm-delivery').disabled = true;
      }


      



      function selectPaymentMethod(method) {
        selectedPaymentMethod = method;
        document.getElementById('confirm-delivery').disabled = false;
        document.querySelectorAll('.payment-option').forEach(option => {
          option.style.background = 'rgba(20, 20, 20, 0.8)';
        });
        event.currentTarget.style.background = 'rgba(207, 149, 36, 0.2)';
      }
      window.selectPaymentMethod = selectPaymentMethod;

     
function closeSidebar() {
    console.log("🔒 Cerrando sidebar...");
    
    const sidebar = document.getElementById('sidebar');
    const sidebarBackdrop = document.getElementById('sidebar-backdrop');
    
    if (sidebar) {
        sidebar.classList.remove('open');
        console.log("✅ Sidebar cerrado");
    }
    if (sidebarBackdrop) {
        sidebarBackdrop.style.display = 'none';
        console.log("✅ Backdrop ocultado");
    }
    
    // Asegurarse de que el body no tenga scroll bloqueado
    document.body.style.overflow = 'auto';
}

window.closeSidebar = closeSidebar;


// 🔥 NUEVAS FUNCIONES PARA ARCHIVADO E HISTORIAL

let historialServices = [];
let currentHistorialFilter = 'all';

async function loadArchivableServices() {
    try {
        const [entregadosSnapshot, canceladosSnapshot] = await Promise.all([
            db.collection('services').where('estado', '==', 'entregado').get(),
            db.collection('services').where('estado', '==', 'cancelado').get()
        ]);

        const now = Date.now();
        const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000);

        let countEntregados = 0;
        let countCancelados = 0;

        entregadosSnapshot.forEach(doc => {
            const data = doc.data();
            const fechaCreacion = data.fechaCreacion?.toDate?.().getTime() || 0;
            if (fechaCreacion < twentyFourHoursAgo) countEntregados++;
        });

        canceladosSnapshot.forEach(doc => {
            const data = doc.data();
            const fechaCreacion = data.fechaCreacion?.toDate?.().getTime() || 0;
            if (fechaCreacion < twentyFourHoursAgo) countCancelados++;
        });

        document.getElementById('count-entregados').textContent = countEntregados;
        document.getElementById('count-cancelados').textContent = countCancelados;
        document.getElementById('count-total').textContent = countEntregados + countCancelados;

    } catch (error) {
        console.error('Error cargando servicios archivables:', error);
        alert('Error al cargar el conteo de servicios');
    }
}

async function confirmArchive() {
    const total = parseInt(document.getElementById('count-total').textContent);
    if (total === 0) {
        alert('No hay servicios para archivar');
        return;
    }

    if (!confirm(`¿Archivar ${total} servicios completados con más de 24 horas?`)) {
        return;
    }

    await archiveOldServices();
}

async function archiveOldServices() {
    if (currentRole !== 'admin') {
        alert('Solo los administradores pueden archivar pedidos.');
        return;
    }

    const progressEl = document.getElementById('archive-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    try {
        const [entregadosSnapshot, canceladosSnapshot] = await Promise.all([
            db.collection('services').where('estado', '==', 'entregado').get(),
            db.collection('services').where('estado', '==', 'cancelado').get()
        ]);

        const allDocs = [...entregadosSnapshot.docs, ...canceladosSnapshot.docs];
        const now = Date.now();
        const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000);

        const docsToArchive = allDocs.filter(doc => {
            const data = doc.data();
            const fechaCreacion = data.fechaCreacion?.toDate?.().getTime() || 0;
            return fechaCreacion < twentyFourHoursAgo;
        });

        if (docsToArchive.length === 0) {
            alert('No hay servicios para archivar');
            return;
        }

        // Mostrar progreso
        progressEl.classList.remove('hidden');
        let archivedCount = 0;

        for (const doc of docsToArchive) {
            try {
                const data = doc.data();
                
                // Crear en historial
                await db.collection('services_history').doc(doc.id).set({
                    ...data,
                    idOriginal: doc.id,
                    fechaArchivado: firebase.firestore.FieldValue.serverTimestamp(),
                    archivadoPor: currentUser.uid,
                    archivadoPorEmail: currentUser.email
                });
                
                // Eliminar de services
                await db.collection('services').doc(doc.id).delete();
                
                archivedCount++;
                
                // Actualizar progreso
                const progress = (archivedCount / docsToArchive.length) * 100;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${archivedCount}/${docsToArchive.length}`;
                
            } catch (error) {
                console.error(`Error archivando ${doc.id}:`, error);
            }
        }

        progressEl.classList.add('hidden');
        alert(`✅ ${archivedCount} servicios archivados correctamente`);
        
        // Actualizar vistas
        loadArchivableServices();
        if (currentSection === 'historial') {
            loadHistorial();
        }
        
    } catch (error) {
        console.error('Error en archivado:', error);
        progressEl.classList.add('hidden');
        alert('Error al archivar servicios: ' + error.message);
    }
}

async function loadHistorial() {
    console.log("📂 Cargando historial de servicios archivados...");
    
    const historialList = document.getElementById('historial-list');
    const historialEmpty = document.getElementById('historial-empty');
    
    if (!historialList) {
        console.error("❌ No se encontró el elemento #historial-list");
        return;
    }

    historialList.innerHTML = '<div class="text-center text-gold">Cargando historial...</div>';
    
    try {
        const snapshot = await db.collection('services_history')
            .orderBy('fechaArchivado', 'desc')
            .get();

        console.log(`📊 Encontrados ${snapshot.size} servicios en el historial`);
        
        historialServices = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        if (historialServices.length === 0) {
            console.log("📭 No hay servicios en el historial");
            historialList.innerHTML = '';
            historialList.classList.add('hidden');
            if (historialEmpty) historialEmpty.classList.remove('hidden');
        } else {
            console.log("✅ Servicios cargados en historial:", historialServices.length);
            if (historialEmpty) historialEmpty.classList.add('hidden');
            historialList.classList.remove('hidden');
            renderHistorial();
        }

    } catch (error) {
        console.error('❌ Error cargando historial:', error);
        historialList.innerHTML = '<div class="text-center text-red-500">Error cargando historial</div>';
        if (historialEmpty) historialEmpty.classList.add('hidden');
    }
}

function renderHistorial() {
    console.log("🎨 Renderizando historial...");
    
    const historialList = document.getElementById('historial-list');
    const historialEmpty = document.getElementById('historial-empty');
    
    if (!historialList) {
        console.error("❌ No se encontró #historial-list");
        return;
    }
    
    let filteredServices = historialServices;
    
    // Aplicar filtro si no es 'all'
    if (currentHistorialFilter !== 'all') {
        filteredServices = historialServices.filter(service => 
            service.estado === currentHistorialFilter
        );
    }

    console.log(`🔍 Filtro: ${currentHistorialFilter}, Mostrando: ${filteredServices.length} servicios`);

    if (filteredServices.length === 0) {
        historialList.innerHTML = '';
        historialList.classList.add('hidden');
        if (historialEmpty) historialEmpty.classList.remove('hidden');
        return;
    }

    historialList.classList.remove('hidden');
    if (historialEmpty) historialEmpty.classList.add('hidden');
    
    historialList.innerHTML = '';
    
    filteredServices.forEach(service => {
        const card = document.createElement('div');
        card.className = 'service-card';
        
        const fechaArchivado = service.fechaArchivado?.toDate?.().toLocaleString('es-CO') || 'Fecha desconocida';
        const fechaCreacion = service.fechaCreacion?.toDate?.().toLocaleString('es-CO') || 'Fecha desconocida';
        
        card.innerHTML = `
            <div class="service-header">
                <div class="service-client">${service.empresa || service.cliente || 'Sin nombre'}</div>
                <div class="service-status status-${service.estado}">${service.estado}</div>
            </div>
            
            <div class="service-detail">
                <i class="fas fa-user"></i>
                <div class="service-detail-content">
                    <strong>Contacto:</strong> ${service.contacto || 'No especificado'}
                </div>
            </div>
            
            <div class="service-detail">
                <i class="fas fa-map-marker-alt"></i>
                <div class="service-detail-content">
                    <strong>Entrega:</strong> ${service.entregar || 'No especificado'}
                </div>
            </div>
            
            <div class="service-detail">
                <i class="fas fa-calendar-plus"></i>
                <div class="service-detail-content">
                    <strong>Creado:</strong> ${fechaCreacion}
                </div>
            </div>
            
            <div class="service-detail">
                <i class="fas fa-archive"></i>
                <div class="service-detail-content">
                    <strong>Archivado:</strong> ${fechaArchivado}
                </div>
            </div>
            
            <div class="service-detail">
                <i class="fas fa-user-shield"></i>
                <div class="service-detail-content">
                    <strong>Archivado por:</strong> ${service.archivadoPorEmail || 'Sistema'}
                </div>
            </div>
            
            ${service.pagoMensajero ? `
                <div class="service-detail">
                    <i class="fas fa-money-bill-wave"></i>
                    <div class="service-detail-content">
                        <strong>Pago mensajero:</strong> $${Number(service.pagoMensajero).toLocaleString()}
                    </div>
                </div>
            ` : ''}
            
            ${service.observaciones ? `
                <div class="service-detail">
                    <i class="fas fa-sticky-note"></i>
                    <div class="service-detail-content">
                        <strong>Observaciones:</strong> ${service.observaciones}
                    </div>
                </div>
            ` : ''}
        `;
        
        historialList.appendChild(card);
    });
    
    console.log("✅ Historial renderizado correctamente");
}

function setHistorialFilter(filter, element) {
    console.log(`🎯 Aplicando filtro de historial: ${filter}`);
    
    currentHistorialFilter = filter;
    
    // Remover clase active de todos los botones
    document.querySelectorAll('#historial-section .filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Agregar clase active al botón clickeado
    if (element && element.classList) {
        element.classList.add('active');
    }
    
    // Re-renderizar el historial
    renderHistorial();
}
window.setHistorialFilter = setHistorialFilter;

function exportHistorialToCSV() {
    if (historialServices.length === 0) {
        alert('No hay datos para exportar');
        return;
    }

    const headers = ['Empresa', 'Estado', 'Dirección', 'Pago Mensajero', 'Fecha Creación', 'Fecha Archivado'];
    const csvData = historialServices.map(service => [
        service.empresa || service.cliente || '',
        service.estado || '',
        service.entregar || '',
        service.pagoMensajero || 0,
        service.fechaCreacion?.toDate?.().toLocaleString('es-CO') || '',
        service.fechaArchivado?.toDate?.().toLocaleString('es-CO') || ''
    ]);

    const csvContent = [headers, ...csvData]
        .map(row => row.map(field => `"${field}"`).join(','))
        .join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `historial_servicios_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function showSection(section) {
    console.log("🎯 Mostrando sección:", section);
    currentSection = section;

    // Ocultar TODAS las secciones principales
    const sections = [
        'services-section',
        'financial-section', 
        'pending-mensajeros-section',
        'costos-section',
        'cobros-section',
        'archivar-section',
        'historial-section'
    ];

    sections.forEach(sectionId => {
        const element = document.getElementById(sectionId);
        if (element) {
            element.classList.add('hidden');
        }
    });

    // Ocultar también el banner pendiente si está visible
    const pendingBanner = document.getElementById('pending-banner');
    if (pendingBanner) {
        pendingBanner.classList.add('hidden');
    }

    // Mostrar la sección target
    const targetSection = document.getElementById(`${section}-section`);
    if (targetSection) {
        targetSection.classList.remove('hidden');
        console.log("✅ Sección mostrada:", targetSection.id);
    } else {
        console.error("❌ No se encontró la sección:", section);
        // Fallback: mostrar servicios
        const fallbackSection = document.getElementById('services-section');
        if (fallbackSection) {
            fallbackSection.classList.remove('hidden');
            console.log("🔄 Mostrando servicios por defecto");
        }
    }

    // Manejar filtros - solo mostrar en servicios
    const filtersEl = document.getElementById('filters');
    if (filtersEl) {
        if (section === 'services') {
            filtersEl.classList.remove('hidden');
        } else {
            filtersEl.classList.add('hidden');
        }
    }

    // ✅ CERRAR SIDEBAR SIEMPRE
    closeSidebar();

    // Lógica específica de cada sección
    switch (section) {
        case 'services':
            console.log("➡️ Mostrando lógica de servicios");
            if (services && services.length > 0) {
                renderServices();
            }
            break;
        case 'financial':
            console.log("➡️ Mostrando lógica financiera");
            if (currentRole === 'mensajero') {
                renderFinancialSummary();
            }
            break;
        case 'pending-mensajeros':
            console.log("➡️ Mostrando solicitudes de mensajeros");
            if (currentRole === 'admin') {
                subscribePendingMensajeros();
            }
            break;
        case 'costos':
            console.log("➡️ Mostrando costos");
            if (currentRole === 'admin') {
                renderCostos();
            }
            break;
        case 'cobros':
            console.log("➡️ Mostrando cobros");
            if (currentRole === 'admin') {
                renderCobros();
            }
            break;
        case 'archivar':
            console.log("➡️ Mostrando archivar");
            if (currentRole === 'admin') {
                loadArchivableServices();
            }
            break;
        case 'historial':
            console.log("➡️ Mostrando historial");
            if (currentRole === 'admin') {
                loadHistorial();
            }
            break;
        default:
            console.log("⚠️ No hay lógica definida para:", section);
    }
}

window.showSection = showSection;




 function setFilter(filter, element) {
    console.log("Filtro seleccionado:", filter);
    console.log("Botón clickeado:", element);

    // Actualizamos la variable global
    currentFilter = filter;

    // Quitar 'active' de todos los botones
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Agregar 'active' al botón que se clickeó
    if (element instanceof HTMLElement) {
        element.classList.add('active');
    }

    // 🔥 IMPORTANTE: Volver a renderizar los servicios con el nuevo filtro
    renderServices();
}
window.setFilter = setFilter;





      function showFinancialSummary() {
        showSection('financial');
        renderFinancialSummary();
      }
      window.showFinancialSummary = showFinancialSummary;

      // Todas las demás funciones (renderFinancialSummary, markAsPaid, etc.) se mantienen igual...
      
      async function renderFinancialSummary() {
        const financialList = document.getElementById('financial-list');
        financialList.innerHTML = '<div class="text-center text-gold">Cargando resumen financiero...</div>';
        
        try {
          const snapshot = await db.collection('services')
            .where('uidMensajero', '==', currentUser.uid)
            .where('estado', '==', 'entregado')
            .get();
          
          if (snapshot.empty) {
            financialList.innerHTML = '<div class="text-center text-gold">No hay servicios entregados</div>';
            ['total-earned', 'total-pending', 'total-paid'].forEach(id => document.getElementById(id).textContent = '$0');
            return;
          }
          
          const services = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          
          let totalEarned = 0, totalPending = 0, totalPaid = 0;
          
          services.forEach(service => {
            const amount = service.pagoMensajero || 0;
            totalEarned += amount;
            if (service.pagado) totalPaid += amount;
            else totalPending += amount;
          });
          
          document.getElementById('total-earned').textContent = `$${totalEarned.toLocaleString()}`;
          document.getElementById('total-pending').textContent = `$${totalPending.toLocaleString()}`;
          document.getElementById('total-paid').textContent = `$${totalPaid.toLocaleString()}`;
          
          const servicesByDate = {};
          services.forEach(service => {
            const date = (service.fechaEntrega && service.fechaEntrega.toDate) ? service.fechaEntrega.toDate().toLocaleDateString('es-CO') : 'Fecha desconocida';
            if (!servicesByDate[date]) servicesByDate[date] = [];
            servicesByDate[date].push(service);
          });
          
          financialList.innerHTML = '';
          
          Object.keys(servicesByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
            const dateSection = document.createElement('div');
            dateSection.className = 'history-day';
            
            let dayTotal = 0, dayPaid = 0, dayPending = 0;
            servicesByDate[date].forEach(s => {
              const amount = s.pagoMensajero || 0;
              dayTotal += amount;
              if (s.pagado) dayPaid += amount;
              else dayPending += amount;
            });
            
            dateSection.innerHTML = `<div class="history-date">${date} - Total: $${dayTotal.toLocaleString()} (Pagado: $${dayPaid.toLocaleString()}, Pendiente: $${dayPending.toLocaleString()})</div>`;
            
            servicesByDate[date].forEach(service => {
              const serviceCard = document.createElement('div');
              serviceCard.className = 'service-card';
              serviceCard.innerHTML = `
                <div class="service-header">
                  <div class="service-client">${service.empresa || 'Sin nombre'}</div>
                  <div class="service-status ${service.pagado ? 'status-entregado' : 'status-pendiente'}">${service.pagado ? 'Pagado' : 'Pendiente'}</div>
                </div>
                <div class="service-detail"><i class="fas fa-map-marker-alt"></i><div class="service-detail-content">${service.entregar || 'N/A'}</div></div>
                <div class="service-detail"><i class="fas fa-money-bill-wave"></i><div class="service-detail-content">$${(service.pagoMensajero || 0).toLocaleString()}</div></div>
                ${!service.pagado ? `<div class="service-actions"><button class="btn-primary action-btn" onclick="markAsPaid('${service.id}')">Marcar como pagado</button></div>` : ''}
              `;
              dateSection.appendChild(serviceCard);
            });
            financialList.appendChild(dateSection);
          });
        } catch (error) {
          console.error('Error cargando resumen financiero:', error);
          financialList.innerHTML = '<div class="text-center text-red-500">Error cargando el resumen financiero</div>';
        }
      }

      async function markAsPaid(serviceId) {
        try {
          await db.collection('services').doc(serviceId).update({
            pagado: true,
            fechaPago: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert('Servicio marcado como pagado');
          renderFinancialSummary();
        } catch (error) {
          console.error('Error marcando como pagado:', error);
          alert('Error al marcar como pagado');
        }
      }
      window.markAsPaid = markAsPaid;

      async function listPendingMensajeros() {
    // Muestra la sección de pendientes
    showSection('pending-container');

    // Obtener referencia al contenedor
    const pendingContainer = document.getElementById('pending-container');
  const pendingList = document.getElementById('pending-list');


    if (!pendingListEl) {
      console.error("❌ No se encontró el contenedor #pending-list en el DOM");
      return;
    }

    // Mostrar mensaje de carga
    pendingListEl.innerHTML = '<div class="text-center text-gold">Cargando solicitudes...</div>';

    try {
      // Traer los datos desde Firestore
      const snapshot = await db.collection('users')
        .where('role', '==', 'pending_mensajero')
        .orderBy('createdAt', 'asc')
        .get();

      if (snapshot.empty) {
        pendingListEl.innerHTML = '<div class="text-center text-gold">No hay solicitudes pendientes.</div>';
        return;
      }

      // Construir HTML dinámicamente
      let html = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const createdAt = (data.createdAt && typeof data.createdAt.toDate === 'function')
          ? data.createdAt.toDate().toLocaleString('es-CO')
          : 'Desconocida';

        html += `
          <div class="bg-gray-800 text-white p-4 rounded-lg shadow mb-3">
            <p><strong>Nombre:</strong> ${data.displayName || 'Sin nombre'}</p>
            <p><strong>Email:</strong> ${data.email || 'Sin email'}</p>
            <p><strong>Teléfono:</strong> ${data.phoneNumber || 'No especificado'}</p>
            <p><strong>Fecha de registro:</strong> ${createdAt}</p>

            <div class="flex gap-2 mt-3">
              <button onclick="aprobarMensajero('${doc.id}')"
                      class="bg-green-600 px-3 py-1 rounded text-white hover:bg-green-700">
                ✅ Aprobar
              </button>
              <button onclick="rechazarMensajero('${doc.id}')"
                      class="bg-red-600 px-3 py-1 rounded text-white hover:bg-red-700">
                ❌ Rechazar
              </button>
            </div>
          </div>
        `;
      });

      // Renderizar el contenido final
      pendingListEl.innerHTML = html;

    } catch (error) {
      console.error("❌ Error cargando solicitudes pendientes:", error);
      pendingListEl.innerHTML = `
        <div class="text-center text-red-500">
          Error cargando solicitudes. Revisa la consola.
        </div>
      `;
    }
  }

      window.listPendingMensajeros = listPendingMensajeros;

      async function approveMensajero(userId) {
        try {
          await db.collection('users').doc(userId).update({ role: 'mensajero' });
          alert('Mensajero aprobado');
          listPendingMensajeros();
        } catch (error) {
          console.error('Error aprobando:', error); alert('Error al aprobar');
        }
      }
      window.approveMensajero = approveMensajero;

      async function rejectMensajero(userId) {
        try {
          await db.collection('users').doc(userId).update({ role: 'cliente' });
          alert('Solicitud rechazada');
          listPendingMensajeros();
        } catch (error) {
          console.error('Error rechazando:', error); alert('Error al rechazar');
        }
      }
      window.rejectMensajero = rejectMensajero;

    
  async function renderCostos() {
    const section = document.getElementById('costos-section');
    const empresasContainer = document.getElementById('costos-empresas');

    section.classList.remove('hidden');
    empresasContainer.innerHTML = '<p class="text-center text-gold">Cargando datos...</p>';

    try {
      const snapshot = await db.collection('services').get();

      if (snapshot.empty) {
        empresasContainer.innerHTML = '<p class="text-center text-gold">No hay servicios registrados.</p>';
        return;
      }

      // Procesar datos por empresa
      const dataPorEmpresa = {};

      snapshot.forEach(doc => {
        const data = doc.data();
        const empresa = data.empresa || "Sin empresa";
        const costo = parseFloat(data.costo || 0);

        if (!dataPorEmpresa[empresa]) {
          dataPorEmpresa[empresa] = {
            total: 0,
            servicios: [],
          };
        }

        dataPorEmpresa[empresa].total += costo;
        dataPorEmpresa[empresa].servicios.push({
          direccion: data.entregar,
          fecha: data.fechaCreacion?.toDate().toLocaleString('es-CO') || 'Sin fecha',
          costo,
        });
      });

      // Renderizar empresas
      empresasContainer.innerHTML = '';

      for (const [empresa, datos] of Object.entries(dataPorEmpresa)) {
        let rows = '';
        datos.servicios.forEach(serv => {
          rows += `
            <tr class="border-b border-gray-700">
              <td class="p-2 whitespace-nowrap">${serv.direccion}</td>
              <td class="p-2 whitespace-nowrap">${serv.fecha}</td>
              <td class="p-2 text-right whitespace-nowrap">$${serv.costo.toLocaleString('es-CO')}</td>
            </tr>
          `;
        });

        empresasContainer.innerHTML += `
          <div class="bg-gray-900 text-white rounded-lg shadow p-4">
            <h3 class="text-xl font-semibold text-gold mb-4">${empresa}</h3>

            <!-- Contenedor con scroll horizontal en móvil -->
            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr class="bg-gray-800 text-gray-400">
                    <th class="p-2 whitespace-nowrap">Dirección de Entrega</th>
                    <th class="p-2 whitespace-nowrap">Fecha de Entrega</th>
                    <th class="p-2 whitespace-nowrap text-right">Costo</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>

            <!-- Total por empresa -->
            <div class="text-right text-gold font-bold mt-3">
              Total: $${datos.total.toLocaleString('es-CO')}
            </div>
          </div>
        `;
      }
    } catch (error) {
      console.error("❌ Error cargando costos:", error);
      empresasContainer.innerHTML = `<p class="text-center text-red-500">Error cargando datos</p>`;
    }
  }



  // También necesitamos implementar renderCobros() para la sección de cobros:
  async function renderCobros() {
    const cobrosBody = document.getElementById('cobros-body');
    cobrosBody.innerHTML = '<div class="text-center text-gold">Cargando cobros contra entrega...</div>';

    try {
      // Obtener servicios que tienen cobro contra entrega
      const snapshot = await db.collection('services')
        .where('cobrarProducto', '>', 0)
        .get();
      
      if (snapshot.empty) {
        cobrosBody.innerHTML = '<div class="text-center text-gold">No hay cobros contra entrega</div>';
        return;
      }

      let html = `
        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-gold/20">
                <th class="p-3 text-left border border-gold">Empresa/Cliente</th>
                <th class="p-3 text-left border border-gold">Contacto</th>
                <th class="p-3 text-right border border-gold">Valor a Cobrar</th>
                <th class="p-3 text-left border border-gold">Estado</th>
                <th class="p-3 text-left border border-gold">Mensajero</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      snapshot.docs.forEach(doc => {
        const service = doc.data();
        const empresa = service.empresa || service.cliente || 'Sin nombre';
        
        html += `
          <tr class="border-b border-gold/30">
            <td class="p-3 border border-gold/30">${empresa}</td>
            <td class="p-3 border border-gold/30">${service.contacto || 'N/A'}</td>
            <td class="p-3 text-right border border-gold/30">$${service.cobrarProducto.toLocaleString()}</td>
            <td class="p-3 border border-gold/30">
              <span class="service-status status-${service.estado.replace('_', '')}">
                ${service.estado.replace('_', ' ')}
              </span>
            </td>
            <td class="p-3 border border-gold/30">${service.uidMensajero ? 'Asignado' : 'Sin asignar'}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
      cobrosBody.innerHTML = html;
    } catch (error) {
      console.error('Error cargando cobros contra entrega:', error);
      cobrosBody.innerHTML = '<div class="text-center text-red-500">Error cargando cobros contra entrega</div>';
    }
  }
      
  function openEditProfile() {
    console.log("👤 Abriendo edición de perfil...");
    
    const modal = document.getElementById('edit-profile-modal');
    const nameInput = document.getElementById('profile-displayName');
    
    if (!modal) {
        console.error("❌ Modal no encontrado");
        return;
    }
    
    if (!nameInput) {
        console.error("❌ Input de nombre no encontrado");
        return;
    }
    
    // ✅ CORREGIDO: Obtener el nombre de forma más robusta
    const currentName = currentUser?.displayName || 
                       document.getElementById('user-name')?.textContent || 
                       currentUser?.email || 
                       '';
    
    nameInput.value = currentName;
    modal.classList.remove('hidden');
    
    console.log("✅ Modal abierto. Nombre actual:", currentName);
}

window.openEditProfile = openEditProfile;    


      function closeEditProfile() {
        document.getElementById('edit-profile-modal').classList.add('hidden');
      }
      window.closeEditProfile = closeEditProfile;

      async function handleProfileUpdate(e) {
        e.preventDefault();
        const displayName = document.getElementById('profile-displayName').value.trim();
        if (!displayName) { alert('Por favor ingresa un nombre'); return; }
        try {
          await db.collection('users').doc(currentUser.uid).update({ displayName });
          await currentUser.updateProfile({ displayName });
          userNameEl.textContent = displayName;
          alert('Perfil actualizado');
          closeEditProfile();
        } catch (error) {
          console.error('Error actualizando perfil:', error);
          alert('Error al actualizar el perfil');
        }
      }
      
      // Inicializar la aplicación cuando el DOM esté listo
      document.addEventListener('DOMContentLoaded', initApp);
      
  
  function changeEstado(serviceId, nuevoEstado) {
    if (!currentUser) return alert("Debes iniciar sesión");

    let updateData = { estado: nuevoEstado };

    // Si el estado es entregado, guarda fechaEntrega
    if (nuevoEstado === "entregado") {
      updateData.fechaEntrega = firebase.firestore.FieldValue.serverTimestamp();
    }

    db.collection("services").doc(serviceId).update(updateData)
      .then(() => {
        console.log(`Servicio ${serviceId} actualizado a estado: ${nuevoEstado}`);
      })
      .catch(error => {
        console.error("Error al actualizar estado:", error);
        alert("No se pudo actualizar el estado. Intenta de nuevo.");
      });
  }
  function escapeHtml(str) {
    return String(str === undefined || str === null ? '' : str)
      .replace(/&/g, '&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

 // === Función TEMPORAL para ver solicitudes de mensajeros pendientes ===
function subscribePendingMensajeros() {
    console.log("🔍 Cargando solicitudes (versión temporal sin orderBy)...");
    
    const pendingListEl = document.getElementById('pending-mensajeros-list') ||
                         document.getElementById('pending-list') ||
                         document.getElementById('pending-container');

    if (!pendingListEl) {
        console.warn('⚠️ No se encontró contenedor para solicitudes pendientes.');
        return;
    }

    // Mensaje inicial de carga
    pendingListEl.innerHTML = '<div class="text-center text-gold">Cargando solicitudes...</div>';

    // ✅ CONSULTA TEMPORAL sin orderBy (no necesita índice)
    const query = db.collection('users').where('role', '==', 'pending_mensajero');

    const unsubscribe = query.onSnapshot(snapshot => {
        console.log(`📋 Solicitudes encontradas: ${snapshot.size}`);
        
        if (snapshot.empty) {
            pendingListEl.innerHTML = '<div class="text-center text-gold">No hay solicitudes pendientes.</div>';
            return;
        }

        let html = '';
        const solicitudes = [];
        
        // 1. Recolectar todos los documentos
        snapshot.forEach(doc => {
            solicitudes.push({
                id: doc.id,
                data: doc.data()
            });
        });

        // 2. Ordenar manualmente por fecha (más antiguo primero)
        solicitudes.sort((a, b) => {
            const dateA = a.data.createdAt?.toDate?.().getTime() || 0;
            const dateB = b.data.createdAt?.toDate?.().getTime() || 0;
            return dateA - dateB; // Más antiguo primero
        });

        // 3. Generar HTML con el orden manual
        solicitudes.forEach(({id, data}) => {
            const createdAt = (data.createdAt && typeof data.createdAt.toDate === 'function')
                ? data.createdAt.toDate().toLocaleString('es-CO')
                : 'Desconocida';

            html += `
                <div class="bg-gray-800 text-white p-4 rounded-lg shadow mb-3">
                    <p><strong>Nombre:</strong> ${escapeHtml(data.displayName || 'Sin nombre')}</p>
                    <p><strong>Email:</strong> ${escapeHtml(data.email || 'Sin email')}</p>
                    <p><strong>Teléfono:</strong> ${escapeHtml(data.phoneNumber || 'No especificado')}</p>
                    <p><strong>Fecha de registro:</strong> ${createdAt}</p>

                    <div class="flex gap-2 mt-3">
                        <button onclick="aprobarMensajero('${id}')" 
                                class="bg-green-600 px-3 py-1 rounded text-white hover:bg-green-700">
                            ✅ Aprobar
                        </button>
                        <button onclick="rechazarMensajero('${id}')" 
                                class="bg-red-600 px-3 py-1 rounded text-white hover:bg-red-700">
                            ❌ Rechazar
                        </button>
                    </div>
                </div>
            `;
        });

        pendingListEl.innerHTML = html;
        console.log("✅ Solicitudes cargadas correctamente (ordenamiento manual)");

    }, error => {
        console.error('❌ Error cargando solicitudes pendientes:', error);
        pendingListEl.innerHTML = `
            <div class="text-center text-red-500">
                Error cargando solicitudes. Revisa la consola.
            </div>
        `;
    });

    return unsubscribe;
}

window.subscribePendingMensajeros = subscribePendingMensajeros;




  // Aprobar solicitud de mensajero
 async function aprobarMensajero(uid) {
    if (!confirm("¿Estás seguro de aprobar a este mensajero?")) return;
    try {
        await db.collection('users').doc(uid).update({ role: 'mensajero' });
        alert("Mensajero aprobado con éxito.");
    } catch (error) {
        console.error("Error al aprobar mensajero:", error);
        alert("No se pudo aprobar el mensajero. Intenta de nuevo.");
    }
}
window.aprobarMensajero = aprobarMensajero;

  // Rechazar solicitud de mensajero
  async function rechazarMensajero(uid) {
    if (!confirm("¿Estás seguro de rechazar esta solicitud?")) return;
    try {
        await db.collection('users').doc(uid).delete();
        alert("Solicitud rechazada y eliminada.");
    } catch (error) {
        console.error("Error al rechazar solicitud:", error);
        alert("No se pudo rechazar la solicitud. Intenta de nuevo.");
    }
}
window.rechazarMensajero = rechazarMensajero;


  
  // Normalizar número de teléfono para WhatsApp
  function normalizeColombiaPhone(phone) {
    let cleaned = phone.replace(/\D/g, "");
    if (cleaned.startsWith("0")) {
        cleaned = cleaned.substring(1);
    }
    if (!cleaned.startsWith("57")) {
        cleaned = "57" + cleaned;
    }
    return cleaned;
}



    // === Función para guardar el servicio ===
  async function saveService() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        alert("Debes iniciar sesión para guardar un servicio.");
        return;
    }

    const rawPhone = document.getElementById('telefonoInput').value || "";
    const telefonoNormalized = normalizeColombiaPhone(rawPhone);

    console.log("Datos a guardar:", {
        telefono: rawPhone,
        telefonoNormalized,
        uidCliente: currentUser.uid,
        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
    });

    try {
        await db.collection('services').add({
            telefono: rawPhone,
            telefonoNormalized: telefonoNormalized,
            uidCliente: currentUser.uid,
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('Servicio guardado correctamente');
    } catch (error) {
        console.error("Error guardando servicio:", error);
        alert('Error guardando servicio.');
    }
}
window.saveService = saveService;

  // === Función para archivar servicios antiguos ===

async function archiveOldServices() {
    if (currentRole !== 'admin') {
        alert('Solo los administradores pueden archivar pedidos.');
        return;
    }

    console.log("⏳ Iniciando archivado de pedidos antiguos...");
    
    if (!confirm('¿Estás seguro de que deseas archivar pedidos completados con más de 24 horas? Esta acción no se puede deshacer.')) {
        return;
    }

    try {
        // Solo archivar servicios en estado final
        const snapshot = await db.collection('services')
            .where('estado', 'in', ['entregado', 'cancelado'])
            .get();

        if (snapshot.empty) {
            alert("No hay pedidos entregados o cancelados para archivar.");
            return;
        }

        const now = Date.now();
        const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000);
        let count = 0;

        // Usar transacciones individuales en lugar de batch para mejor control
        for (const doc of snapshot.docs) {
            const data = doc.data();
            const fechaCreacion = data.fechaCreacion?.toDate?.().getTime() || 0;
            
            // Solo archivar si tiene más de 24 horas
            if (fechaCreacion < twentyFourHoursAgo) {
                try {
                    // Primero crear en historial
                    await db.collection('services_history').doc(doc.id).set({
                        ...data,
                        idOriginal: doc.id,
                        fechaArchivado: firebase.firestore.FieldValue.serverTimestamp(),
                        archivadoPor: currentUser.uid,
                        archivadoPorEmail: currentUser.email
                    });
                    
                    // Luego eliminar de services
                    await db.collection('services').doc(doc.id).delete();
                    
                    count++;
                    console.log(`✅ Archivado: ${doc.id}`);
                } catch (error) {
                    console.error(`❌ Error archivando ${doc.id}:`, error);
                }
            }
        }

        if (count > 0) {
            alert(`✅ ${count} pedidos archivados correctamente.`);
            // Recargar la vista
            subscribeServicesByRole();
        } else {
            alert("No se encontraron pedidos con más de 24 horas para archivar.");
        }
    } catch (error) {
        console.error("❌ Error en proceso de archivado:", error);
        alert("Error al archivar pedidos: " + error.message);
    }
}

// Función temporal para crear datos de prueba (eliminar después de probar)
async function crearServicioPruebaHistorial() {
    try {
        await db.collection('services_history').doc('test-' + Date.now()).set({
            empresa: "Empresa de Prueba",
            cliente: "Cliente Demo",
            contacto: "Contacto Test",
            entregar: "Dirección de prueba 123",
            estado: "entregado",
            pagoMensajero: 15000,
            observaciones: "Este es un servicio de prueba",
            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
            fechaArchivado: firebase.firestore.FieldValue.serverTimestamp(),
            archivadoPor: currentUser.uid,
            archivadoPorEmail: currentUser.email
        });
        console.log("✅ Servicio de prueba creado en historial");
        loadHistorial(); // Recargar el historial
    } catch (error) {
        console.error("❌ Error creando servicio de prueba:", error);
    }
}

// Llamar esta función una vez si no hay datos:
// crearServicioPruebaHistorial();


  </script>

  </body>
  </html>
