




  // Aprobar solicitud de mensajero
  async function aprobarMensajero(uid) {
    if (!confirm("¬øEst√°s seguro de aprobar a este mensajero?")) return;

    try {
      await db.collection('users').doc(uid).update({ role: 'mensajero' });
      alert("Mensajero aprobado con √©xito.");
    } catch (error) {
      console.error("Error al aprobar mensajero:", error);
      alert("No se pudo aprobar el mensajero. Intenta de nuevo.");
    }
  }
  window.aprobarMensajero = aprobarMensajero;

  // Rechazar solicitud de mensajero
  async function rechazarMensajero(uid) {
    if (!confirm("¬øEst√°s seguro de rechazar esta solicitud?")) return;

    try {
      await db.collection('users').doc(uid).delete();
      alert("Solicitud rechazada y eliminada.");
    } catch (error) {
      console.error("Error al rechazar solicitud:", error);
      alert("No se pudo rechazar la solicitud. Intenta de nuevo.");
    }
  }
  window.rechazarMensajero = rechazarMensajero;


  
  
  // Normalizar n√∫mero de tel√©fono para WhatsApp
  function normalizeColombiaPhone(phone) {
    let cleaned = phone.replace(/\D/g, ""); // Eliminar caracteres no num√©ricos

    // Si empieza por "0", lo quitamos
    if (cleaned.startsWith("0")) {
      cleaned = cleaned.substring(1);
    }

    // Si no empieza por "57", agregamos el prefijo de Colombia
    if (!cleaned.startsWith("57")) {
      cleaned = "57" + cleaned;
    }

    return cleaned;
  }



    // === Funci√≥n para guardar el servicio ===
  async function saveService() {
    const currentUser = firebase.auth().currentUser;

    if (!currentUser) {
      alert("Debes iniciar sesi√≥n para guardar un servicio.");
      return;
    }

    // Obt√©n el tel√©fono ingresado por el usuario
    const rawPhone = document.getElementById('telefonoInput').value || "";
    const telefonoNormalized = normalizeColombiaPhone(rawPhone);

    // Verifica en consola antes de guardar
    console.log("Datos a guardar:", {
      telefono: rawPhone,
      telefonoNormalized,
      uidCliente: currentUser.uid,
      fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
    });

    try {
      // Guarda el documento en la colecci√≥n "services"
      await db.collection('services').add({
        telefono: rawPhone,                  // Como lo escribi√≥ el usuario
        telefonoNormalized: telefonoNormalized, // Normalizado para WhatsApp y b√∫squedas
        uidCliente: currentUser.uid,
        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp() // ‚úÖ Timestamp correcto
      });

      alert('Servicio guardado correctamente');
    } catch (error) {
      console.error("Error guardando servicio:", error);
      alert('Error guardando servicio. Verifica que tengas permisos y que la colecci√≥n exista.');
    }

    // Hacer que saveService est√© disponible globalmente
    window.saveService = saveService;
  }


  async function archiveOldServices() {
    console.log("‚è≥ Iniciando archivado de pedidos antiguos...");

    const now = Date.now();
    const cutoff = now - (24 * 60 * 60 * 1000); // 24 horas en milisegundos

    try {
      // Obtener todos los pedidos
      const snapshot = await db.collection('services').get();

      if (snapshot.empty) {
        alert("No hay pedidos para archivar.");
        console.log("üì≠ No se encontraron pedidos en la colecci√≥n services.");
        return;
      }

      const batch = db.batch();
      let count = 0;

      snapshot.forEach(doc => {
        const data = doc.data();

        // Solo archivar si fechaCreacion existe y es m√°s vieja de 24 horas
        if (data.fechaCreacion && data.fechaCreacion.toDate().getTime() < cutoff) {

          // Datos reducidos para services_history
          const historyData = {
            empresa: data.empresa || "",
            cliente: data.cliente || "",
            direccionEntrega: data.entregar || "",
            estado: data.estado || "desconocido",
            fechaRegistro: data.fechaCreacion,
            fechaEntrega: data.fechaEntrega || null,
            fechaArchivado: firebase.firestore.FieldValue.serverTimestamp()
          };

          // Guardar en services_history
          const historyRef = db.collection('services_history').doc();
          batch.set(historyRef, historyData);

          // Borrar de services
          batch.delete(db.collection('services').doc(doc.id));

          count++;
        }
      });

      if (count > 0) {
        await batch.commit();
        alert(`‚úÖ ${count} pedidos archivados correctamente.`);
        console.log(`üì¶ ${count} pedidos movidos a services_history.`);
      } else {
        alert("No se encontraron pedidos que cumplan el criterio de 24 horas.");
        console.log("üì≠ Ning√∫n pedido super√≥ el l√≠mite de 24 horas.");
      }

    } catch (error) {
      console.error("‚ùå Error archivando pedidos:", error);
      alert("Error al archivar pedidos. Revisa la consola para m√°s detalles.");
    }
  }



  </script>

  </body>
  </html>
